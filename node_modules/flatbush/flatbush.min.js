!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.flatbush=i()}(this,function(){"use strict";function t(t,i,s){if(void 0===t)throw new Error("Missing required argument: numItems.");this._numItems=t,this._nodeSize=i||16,s=s||Float64Array;for(var a=t,h=a,e=1;h+=a=Math.ceil(a/this._nodeSize),e++,1!==a;);this.data=new s(5*h),this._hilbertValues=new Uint32Array(t),this._levelBoundaries=new Uint32Array(e),this._numAdded=0,this._pos=0,this._minX=1/0,this._minY=1/0,this._maxX=-1/0,this._maxY=-1/0}function i(t,i){for(var s=0,a=i.length-1;s<a;){var h=s+a>>1;i[h]>t?a=h:s=h+1}return i[s]}function s(t,i,s,a){var h=t[s];t[s]=t[a],t[a]=h;var e=5*s,n=5*a,r=i[e],o=i[e+1],d=i[e+2],_=i[e+3],u=i[e+4];i[e]=i[n],i[e+1]=i[n+1],i[e+2]=i[n+2],i[e+3]=i[n+3],i[e+4]=i[n+4],i[n]=r,i[n+1]=o,i[n+2]=d,i[n+3]=_,i[n+4]=u}function a(t,i){var s=t^i,a=65535^s,h=65535^(t|i),e=t&(65535^i),n=s|a>>1,r=s>>1^s,o=h>>1^a&e>>1^h,d=s&h>>1^e>>1^e;r=(s=n)&(a=r)>>2^a&(s^a)>>2,o^=s&(h=o)>>2^a&(e=d)>>2,d^=a&h>>2^(s^a)&e>>2,r=(s=n=s&s>>2^a&a>>2)&(a=r)>>4^a&(s^a)>>4,o^=s&(h=o)>>4^a&(e=d)>>4,d^=a&h>>4^(s^a)&e>>4,o^=(s=n=s&s>>4^a&a>>4)&(h=o)>>8^(a=r)&(e=d)>>8;var _=t^i,u=(a=(d^=a&h>>8^(s^a)&e>>8)^d>>1)|65535^(_|(s=o^o>>1));return((u=1431655765&((u=858993459&((u=252645135&((u=16711935&(u|u<<8))|u<<4))|u<<2))|u<<1))<<1|(_=1431655765&((_=858993459&((_=252645135&((_=16711935&(_|_<<8))|_<<4))|_<<2))|_<<1)))>>>0}return t.prototype={add:function(t,i,s,a){this.data[this._pos++]=this._numAdded++,this.data[this._pos++]=t,this.data[this._pos++]=i,this.data[this._pos++]=s,this.data[this._pos++]=a,t<this._minX&&(this._minX=t),i<this._minY&&(this._minY=i),s>this._maxX&&(this._maxX=s),a>this._maxY&&(this._maxY=a)},finish:function(){if(this._numAdded!==this._numItems)throw new Error("Added "+this._numAdded+" items when expected "+this._numItems);for(var t=this._maxX-this._minX,i=this._maxY-this._minY,h=0;h<this._numItems;h++){var e=Math.floor(65535*(this.data[5*h+1]-this._minX)/t),n=Math.floor(65535*(this.data[5*h+2]-this._minY)/i);this._hilbertValues[h]=a(e,n)}!function t(i,a,h,e){if(h>=e)return;var n=i[h];var r=h-1;var o=e+1;for(;;){for(;i[++r]<n;);for(;i[--o]>n;);if(r>=o)break;s(i,a,r,o)}t(i,a,h,o);t(i,a,o+1,e)}(this._hilbertValues,this.data,0,this._numItems-1);var r=0,o=this._numItems,d=0;do{var _=r+5*o;for(o=Math.ceil(o/this._nodeSize),this._levelBoundaries[d++]=this._pos;r<_;){var u=1/0,m=1/0,f=-1/0,l=-1/0,v=r;for(h=0;h<this._nodeSize&&r<_;h++){r++;var p=this.data[r++],c=this.data[r++],x=this.data[r++],w=this.data[r++];p<u&&(u=p),c<m&&(m=c),x>f&&(f=x),w>l&&(l=w)}this.data[this._pos++]=v,this.data[this._pos++]=u,this.data[this._pos++]=m,this.data[this._pos++]=f,this.data[this._pos++]=l}}while(1!==o);this._levelBoundaries[d++]=this._pos},search:function(t,s,a,h,e){if(0===this._levelBoundaries[0])throw new Error("Data not yet indexed - call index.finish().");for(var n=this.data.length-5,r=[],o=[];void 0!==n;){for(var d=i(n,this._levelBoundaries),_=0;_<this._nodeSize;_++){var u=n+5*_;if(_>0&&u>=d)break;var m=this.data[u++];if(!(a<this.data[u++])&&!(h<this.data[u++]||t>this.data[u++]||s>this.data[u++]))if(n<5*this._numItems){var f=!0;void 0!==e&&(f=e(m)),f&&o.push(m)}else r.push(m)}n=r.pop()}return o}},function(i,s,a){return new t(i,s,a)}});