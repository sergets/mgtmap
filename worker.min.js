/** vim: et:ts=4:sw=4:sts=4
 * @license RequireJS 2.3.5 Copyright jQuery Foundation and other contributors.
 * Released under MIT license, https://github.com/requirejs/requirejs/blob/master/LICENSE
 */

/**
 * @module vow
 * @author Filatov Dmitry <dfilatov@yandex-team.ru>
 * @version 0.4.17
 * @license
 * Dual licensed under the MIT and GPL licenses:
 *   * http://www.opensource.org/licenses/mit-license.php
 *   * http://www.gnu.org/licenses/gpl.html
 */

var requirejs,require,define;!function(global,setTimeout){function commentReplace(e,t){return t||""}function isFunction(e){return"[object Function]"===ostring.call(e)}function isArray(e){return"[object Array]"===ostring.call(e)}function each(e,t){if(e){var n;for(n=0;n<e.length&&(!e[n]||!t(e[n],n,e));n+=1);}}function eachReverse(e,t){if(e){var n;for(n=e.length-1;n>-1&&(!e[n]||!t(e[n],n,e));n-=1);}}function hasProp(e,t){return hasOwn.call(e,t)}function getOwn(e,t){return hasProp(e,t)&&e[t]}function eachProp(e,t){var n;for(n in e)if(hasProp(e,n)&&t(e[n],n))break}function mixin(e,t,n,r){return t&&eachProp(t,function(t,i){!n&&hasProp(e,i)||(!r||"object"!=typeof t||!t||isArray(t)||isFunction(t)||t instanceof RegExp?e[i]=t:(e[i]||(e[i]={}),mixin(e[i],t,n,r)))}),e}function bind(e,t){return function(){return t.apply(e,arguments)}}function scripts(){return document.getElementsByTagName("script")}function defaultOnError(e){throw e}function getGlobal(e){if(!e)return e;var t=global;return each(e.split("."),function(e){t=t[e]}),t}function makeError(e,t,n,r){var i=new Error(t+"\nhttp://requirejs.org/docs/errors.html#"+e);return i.requireType=e,i.requireModules=r,n&&(i.originalError=n),i}function newContext(e){function t(e){var t,n;for(t=0;t<e.length;t++)if("."===(n=e[t]))e.splice(t,1),t-=1;else if(".."===n){if(0===t||1===t&&".."===e[2]||".."===e[t-1])continue;t>0&&(e.splice(t-1,2),t-=2)}}function n(e,n,r){var i,o,s,a,u,c,l,f,d,h,p,g=n&&n.split("/"),m=_.map,v=m&&m["*"];if(e&&(e=e.split("/"),c=e.length-1,_.nodeIdCompat&&jsSuffixRegExp.test(e[c])&&(e[c]=e[c].replace(jsSuffixRegExp,"")),"."===e[0].charAt(0)&&g&&(p=g.slice(0,g.length-1),e=p.concat(e)),t(e),e=e.join("/")),r&&m&&(g||v)){o=e.split("/");e:for(s=o.length;s>0;s-=1){if(u=o.slice(0,s).join("/"),g)for(a=g.length;a>0;a-=1)if((i=getOwn(m,g.slice(0,a).join("/")))&&(i=getOwn(i,u))){l=i,f=s;break e}!d&&v&&getOwn(v,u)&&(d=getOwn(v,u),h=s)}!l&&d&&(l=d,f=h),l&&(o.splice(0,f,l),e=o.join("/"))}return getOwn(_.pkgs,e)||e}function r(e){isBrowser&&each(scripts(),function(t){if(t.getAttribute("data-requiremodule")===e&&t.getAttribute("data-requirecontext")===w.contextName)return t.parentNode.removeChild(t),!0})}function i(e){var t=getOwn(_.paths,e);if(t&&isArray(t)&&t.length>1)return t.shift(),w.require.undef(e),w.makeRequire(null,{skipMap:!0})([e]),!0}function o(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function s(e,t,r,i){var s,a,u,c,l=null,f=t?t.name:null,d=e,h=!0,p="";return e||(h=!1,e="_@r"+(q+=1)),c=o(e),l=c[0],e=c[1],l&&(l=n(l,f,i),a=getOwn(R,l)),e&&(l?p=r?e:a&&a.normalize?a.normalize(e,function(e){return n(e,f,i)}):-1===e.indexOf("!")?n(e,f,i):e:(p=n(e,f,i),c=o(p),l=c[0],p=c[1],r=!0,s=w.nameToUrl(p))),u=!l||a||r?"":"_unnormalized"+(C+=1),{prefix:l,name:p,parentMap:t,unnormalized:!!u,url:s,originalName:d,isDefine:h,id:(l?l+"!"+p:p)+u}}function a(e){var t=e.id,n=getOwn(E,t);return n||(n=E[t]=new w.Module(e)),n}function u(e,t,n){var r=e.id,i=getOwn(E,r);!hasProp(R,r)||i&&!i.defineEmitComplete?(i=a(e),i.error&&"error"===t?n(i.error):i.on(t,n)):"defined"===t&&n(R[r])}function c(e,t){var n=e.requireModules,r=!1;t?t(e):(each(n,function(t){var n=getOwn(E,t);n&&(n.error=e,n.events.error&&(r=!0,n.emit("error",e)))}),r||req.onError(e))}function l(){globalDefQueue.length&&(each(globalDefQueue,function(e){var t=e[0];"string"==typeof t&&(w.defQueueMap[t]=!0),k.push(e)}),globalDefQueue=[])}function f(e){delete E[e],delete M[e]}function d(e,t,n){var r=e.map.id;e.error?e.emit("error",e.error):(t[r]=!0,each(e.depMaps,function(r,i){var o=r.id,s=getOwn(E,o);!s||e.depMatched[i]||n[o]||(getOwn(t,o)?(e.defineDep(i,R[o]),e.check()):d(s,t,n))}),n[r]=!0)}function h(){var e,t,n=1e3*_.waitSeconds,o=n&&w.startTime+n<(new Date).getTime(),s=[],a=[],u=!1,l=!0;if(!y){if(y=!0,eachProp(M,function(e){var n=e.map,c=n.id;if(e.enabled&&(n.isDefine||a.push(e),!e.error))if(!e.inited&&o)i(c)?(t=!0,u=!0):(s.push(c),r(c));else if(!e.inited&&e.fetched&&n.isDefine&&(u=!0,!n.prefix))return l=!1}),o&&s.length)return e=makeError("timeout","Load timeout for modules: "+s,null,s),e.contextName=w.contextName,c(e);l&&each(a,function(e){d(e,{},{})}),o&&!t||!u||!isBrowser&&!isWebWorker||O||(O=setTimeout(function(){O=0,h()},50)),y=!1}}function p(e){hasProp(R,e[0])||a(s(e[0],null,!0)).init(e[1],e[2])}function g(e,t,n,r){e.detachEvent&&!isOpera?r&&e.detachEvent(r,t):e.removeEventListener(n,t,!1)}function m(e){var t=e.currentTarget||e.srcElement;return g(t,w.onScriptLoad,"load","onreadystatechange"),g(t,w.onScriptError,"error"),{node:t,id:t&&t.getAttribute("data-requiremodule")}}function v(){var e;for(l();k.length;){if(e=k.shift(),null===e[0])return c(makeError("mismatch","Mismatched anonymous define() module: "+e[e.length-1]));p(e)}w.defQueueMap={}}var y,b,w,x,O,_={waitSeconds:7,baseUrl:"./",paths:{},bundles:{},pkgs:{},shim:{},config:{}},E={},M={},j={},k=[],R={},S={},P={},q=1,C=1;return x={require:function(e){return e.require?e.require:e.require=w.makeRequire(e.map)},exports:function(e){if(e.usingExports=!0,e.map.isDefine)return e.exports?R[e.map.id]=e.exports:e.exports=R[e.map.id]={}},module:function(e){return e.module?e.module:e.module={id:e.map.id,uri:e.map.url,config:function(){return getOwn(_.config,e.map.id)||{}},exports:e.exports||(e.exports={})}}},b=function(e){this.events=getOwn(j,e.id)||{},this.map=e,this.shim=getOwn(_.shim,e.id),this.depExports=[],this.depMaps=[],this.depMatched=[],this.pluginMaps={},this.depCount=0},b.prototype={init:function(e,t,n,r){r=r||{},this.inited||(this.factory=t,n?this.on("error",n):this.events.error&&(n=bind(this,function(e){this.emit("error",e)})),this.depMaps=e&&e.slice(0),this.errback=n,this.inited=!0,this.ignore=r.ignore,r.enabled||this.enabled?this.enable():this.check())},defineDep:function(e,t){this.depMatched[e]||(this.depMatched[e]=!0,this.depCount-=1,this.depExports[e]=t)},fetch:function(){if(!this.fetched){this.fetched=!0,w.startTime=(new Date).getTime();var e=this.map;if(!this.shim)return e.prefix?this.callPlugin():this.load();w.makeRequire(this.map,{enableBuildCallback:!0})(this.shim.deps||[],bind(this,function(){return e.prefix?this.callPlugin():this.load()}))}},load:function(){var e=this.map.url;S[e]||(S[e]=!0,w.load(this.map.id,e))},check:function(){if(this.enabled&&!this.enabling){var e,t,n=this.map.id,r=this.depExports,i=this.exports,o=this.factory;if(this.inited){if(this.error)this.emit("error",this.error);else if(!this.defining){if(this.defining=!0,this.depCount<1&&!this.defined){if(isFunction(o)){if(this.events.error&&this.map.isDefine||req.onError!==defaultOnError)try{i=w.execCb(n,o,r,i)}catch(t){e=t}else i=w.execCb(n,o,r,i);if(this.map.isDefine&&void 0===i&&(t=this.module,t?i=t.exports:this.usingExports&&(i=this.exports)),e)return e.requireMap=this.map,e.requireModules=this.map.isDefine?[this.map.id]:null,e.requireType=this.map.isDefine?"define":"require",c(this.error=e)}else i=o;if(this.exports=i,this.map.isDefine&&!this.ignore&&(R[n]=i,req.onResourceLoad)){var s=[];each(this.depMaps,function(e){s.push(e.normalizedMap||e)}),req.onResourceLoad(w,this.map,s)}f(n),this.defined=!0}this.defining=!1,this.defined&&!this.defineEmitted&&(this.defineEmitted=!0,this.emit("defined",this.exports),this.defineEmitComplete=!0)}}else hasProp(w.defQueueMap,n)||this.fetch()}},callPlugin:function(){var e=this.map,t=e.id,r=s(e.prefix);this.depMaps.push(r),u(r,"defined",bind(this,function(r){var i,o,l,d=getOwn(P,this.map.id),h=this.map.name,p=this.map.parentMap?this.map.parentMap.name:null,g=w.makeRequire(e.parentMap,{enableBuildCallback:!0});return this.map.unnormalized?(r.normalize&&(h=r.normalize(h,function(e){return n(e,p,!0)})||""),o=s(e.prefix+"!"+h,this.map.parentMap,!0),u(o,"defined",bind(this,function(e){this.map.normalizedMap=o,this.init([],function(){return e},null,{enabled:!0,ignore:!0})})),void((l=getOwn(E,o.id))&&(this.depMaps.push(o),this.events.error&&l.on("error",bind(this,function(e){this.emit("error",e)})),l.enable()))):d?(this.map.url=w.nameToUrl(d),void this.load()):(i=bind(this,function(e){this.init([],function(){return e},null,{enabled:!0})}),i.error=bind(this,function(e){this.inited=!0,this.error=e,e.requireModules=[t],eachProp(E,function(e){0===e.map.id.indexOf(t+"_unnormalized")&&f(e.map.id)}),c(e)}),i.fromText=bind(this,function(n,r){var o=e.name,u=s(o),l=useInteractive;r&&(n=r),l&&(useInteractive=!1),a(u),hasProp(_.config,t)&&(_.config[o]=_.config[t]);try{req.exec(n)}catch(e){return c(makeError("fromtexteval","fromText eval for "+t+" failed: "+e,e,[t]))}l&&(useInteractive=!0),this.depMaps.push(u),w.completeLoad(o),g([o],i)}),void r.load(e.name,g,i,_))})),w.enable(r,this),this.pluginMaps[r.id]=r},enable:function(){M[this.map.id]=this,this.enabled=!0,this.enabling=!0,each(this.depMaps,bind(this,function(e,t){var n,r,i;if("string"==typeof e){if(e=s(e,this.map.isDefine?this.map:this.map.parentMap,!1,!this.skipMap),this.depMaps[t]=e,i=getOwn(x,e.id))return void(this.depExports[t]=i(this));this.depCount+=1,u(e,"defined",bind(this,function(e){this.undefed||(this.defineDep(t,e),this.check())})),this.errback?u(e,"error",bind(this,this.errback)):this.events.error&&u(e,"error",bind(this,function(e){this.emit("error",e)}))}n=e.id,r=E[n],hasProp(x,n)||!r||r.enabled||w.enable(e,this)})),eachProp(this.pluginMaps,bind(this,function(e){var t=getOwn(E,e.id);t&&!t.enabled&&w.enable(e,this)})),this.enabling=!1,this.check()},on:function(e,t){var n=this.events[e];n||(n=this.events[e]=[]),n.push(t)},emit:function(e,t){each(this.events[e],function(e){e(t)}),"error"===e&&delete this.events[e]}},w={config:_,contextName:e,registry:E,defined:R,urlFetched:S,defQueue:k,defQueueMap:{},Module:b,makeModuleMap:s,nextTick:req.nextTick,onError:c,configure:function(e){if(e.baseUrl&&"/"!==e.baseUrl.charAt(e.baseUrl.length-1)&&(e.baseUrl+="/"),"string"==typeof e.urlArgs){var t=e.urlArgs;e.urlArgs=function(e,n){return(-1===n.indexOf("?")?"?":"&")+t}}var n=_.shim,r={paths:!0,bundles:!0,config:!0,map:!0};eachProp(e,function(e,t){r[t]?(_[t]||(_[t]={}),mixin(_[t],e,!0,!0)):_[t]=e}),e.bundles&&eachProp(e.bundles,function(e,t){each(e,function(e){e!==t&&(P[e]=t)})}),e.shim&&(eachProp(e.shim,function(e,t){isArray(e)&&(e={deps:e}),!e.exports&&!e.init||e.exportsFn||(e.exportsFn=w.makeShimExports(e)),n[t]=e}),_.shim=n),e.packages&&each(e.packages,function(e){var t,n;e="string"==typeof e?{name:e}:e,n=e.name,t=e.location,t&&(_.paths[n]=e.location),_.pkgs[n]=e.name+"/"+(e.main||"main").replace(currDirRegExp,"").replace(jsSuffixRegExp,"")}),eachProp(E,function(e,t){e.inited||e.map.unnormalized||(e.map=s(t,null,!0))}),(e.deps||e.callback)&&w.require(e.deps||[],e.callback)},makeShimExports:function(e){function t(){var t;return e.init&&(t=e.init.apply(global,arguments)),t||e.exports&&getGlobal(e.exports)}return t},makeRequire:function(t,i){function o(n,r,u){var l,f,d;return i.enableBuildCallback&&r&&isFunction(r)&&(r.__requireJsBuild=!0),"string"==typeof n?isFunction(r)?c(makeError("requireargs","Invalid require call"),u):t&&hasProp(x,n)?x[n](E[t.id]):req.get?req.get(w,n,t,o):(f=s(n,t,!1,!0),l=f.id,hasProp(R,l)?R[l]:c(makeError("notloaded",'Module name "'+l+'" has not been loaded yet for context: '+e+(t?"":". Use require([])")))):(v(),w.nextTick(function(){v(),d=a(s(null,t)),d.skipMap=i.skipMap,d.init(n,r,u,{enabled:!0}),h()}),o)}return i=i||{},mixin(o,{isBrowser:isBrowser,toUrl:function(e){var r,i=e.lastIndexOf("."),o=e.split("/")[0],s="."===o||".."===o;return-1!==i&&(!s||i>1)&&(r=e.substring(i,e.length),e=e.substring(0,i)),w.nameToUrl(n(e,t&&t.id,!0),r,!0)},defined:function(e){return hasProp(R,s(e,t,!1,!0).id)},specified:function(e){return e=s(e,t,!1,!0).id,hasProp(R,e)||hasProp(E,e)}}),t||(o.undef=function(e){l();var n=s(e,t,!0),i=getOwn(E,e);i.undefed=!0,r(e),delete R[e],delete S[n.url],delete j[e],eachReverse(k,function(t,n){t[0]===e&&k.splice(n,1)}),delete w.defQueueMap[e],i&&(i.events.defined&&(j[e]=i.events),f(e))}),o},enable:function(e){getOwn(E,e.id)&&a(e).enable()},completeLoad:function(e){var t,n,r,o=getOwn(_.shim,e)||{},s=o.exports;for(l();k.length;){if(n=k.shift(),null===n[0]){if(n[0]=e,t)break;t=!0}else n[0]===e&&(t=!0);p(n)}if(w.defQueueMap={},r=getOwn(E,e),!t&&!hasProp(R,e)&&r&&!r.inited){if(!(!_.enforceDefine||s&&getGlobal(s)))return i(e)?void 0:c(makeError("nodefine","No define call for "+e,null,[e]));p([e,o.deps||[],o.exportsFn])}h()},nameToUrl:function(e,t,n){var r,i,o,s,a,u,c,l=getOwn(_.pkgs,e);if(l&&(e=l),c=getOwn(P,e))return w.nameToUrl(c,t,n);if(req.jsExtRegExp.test(e))a=e+(t||"");else{for(r=_.paths,i=e.split("/"),o=i.length;o>0;o-=1)if(s=i.slice(0,o).join("/"),u=getOwn(r,s)){isArray(u)&&(u=u[0]),i.splice(0,o,u);break}a=i.join("/"),a+=t||(/^data\:|^blob\:|\?/.test(a)||n?"":".js"),a=("/"===a.charAt(0)||a.match(/^[\w\+\.\-]+:/)?"":_.baseUrl)+a}return _.urlArgs&&!/^blob\:/.test(a)?a+_.urlArgs(e,a):a},load:function(e,t){req.load(w,e,t)},execCb:function(e,t,n,r){return t.apply(r,n)},onScriptLoad:function(e){if("load"===e.type||readyRegExp.test((e.currentTarget||e.srcElement).readyState)){interactiveScript=null;var t=m(e);w.completeLoad(t.id)}},onScriptError:function(e){var t=m(e);if(!i(t.id)){var n=[];return eachProp(E,function(e,r){0!==r.indexOf("_@r")&&each(e.depMaps,function(e){if(e.id===t.id)return n.push(r),!0})}),c(makeError("scripterror",'Script error for "'+t.id+(n.length?'", needed by: '+n.join(", "):'"'),e,[t.id]))}}},w.require=w.makeRequire(),w}function getInteractiveScript(){return interactiveScript&&"interactive"===interactiveScript.readyState?interactiveScript:(eachReverse(scripts(),function(e){if("interactive"===e.readyState)return interactiveScript=e}),interactiveScript)}var req,s,head,baseElement,dataMain,src,interactiveScript,currentlyAddingScript,mainScript,subPath,version="2.3.5",commentRegExp=/\/\*[\s\S]*?\*\/|([^:"'=]|^)\/\/.*$/gm,cjsRequireRegExp=/[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,jsSuffixRegExp=/\.js$/,currDirRegExp=/^\.\//,op=Object.prototype,ostring=op.toString,hasOwn=op.hasOwnProperty,isBrowser=!("undefined"==typeof window||"undefined"==typeof navigator||!window.document),isWebWorker=!isBrowser&&"undefined"!=typeof importScripts,readyRegExp=isBrowser&&"PLAYSTATION 3"===navigator.platform?/^complete$/:/^(complete|loaded)$/,defContextName="_",isOpera="undefined"!=typeof opera&&"[object Opera]"===opera.toString(),contexts={},cfg={},globalDefQueue=[],useInteractive=!1;if(void 0===define){if(void 0!==requirejs){if(isFunction(requirejs))return;cfg=requirejs,requirejs=void 0}void 0===require||isFunction(require)||(cfg=require,require=void 0),req=requirejs=function(e,t,n,r){var i,o,s=defContextName;return isArray(e)||"string"==typeof e||(o=e,isArray(t)?(e=t,t=n,n=r):e=[]),o&&o.context&&(s=o.context),i=getOwn(contexts,s),i||(i=contexts[s]=req.s.newContext(s)),o&&i.configure(o),i.require(e,t,n)},req.config=function(e){return req(e)},req.nextTick=void 0!==setTimeout?function(e){setTimeout(e,4)}:function(e){e()},require||(require=req),req.version=version,req.jsExtRegExp=/^\/|:|\?|\.js$/,req.isBrowser=isBrowser,s=req.s={contexts:contexts,newContext:newContext},req({}),each(["toUrl","undef","defined","specified"],function(e){req[e]=function(){var t=contexts[defContextName];return t.require[e].apply(t,arguments)}}),isBrowser&&(head=s.head=document.getElementsByTagName("head")[0],(baseElement=document.getElementsByTagName("base")[0])&&(head=s.head=baseElement.parentNode)),req.onError=defaultOnError,req.createNode=function(e,t,n){var r=e.xhtml?document.createElementNS("http://www.w3.org/1999/xhtml","html:script"):document.createElement("script");return r.type=e.scriptType||"text/javascript",r.charset="utf-8",r.async=!0,r},req.load=function(e,t,n){var r,i=e&&e.config||{};if(isBrowser)return r=req.createNode(i,t,n),r.setAttribute("data-requirecontext",e.contextName),r.setAttribute("data-requiremodule",t),!r.attachEvent||r.attachEvent.toString&&r.attachEvent.toString().indexOf("[native code")<0||isOpera?(r.addEventListener("load",e.onScriptLoad,!1),r.addEventListener("error",e.onScriptError,!1)):(useInteractive=!0,r.attachEvent("onreadystatechange",e.onScriptLoad)),r.src=n,i.onNodeCreated&&i.onNodeCreated(r,i,t,n),currentlyAddingScript=r,baseElement?head.insertBefore(r,baseElement):head.appendChild(r),currentlyAddingScript=null,r;if(isWebWorker)try{setTimeout(function(){},0),importScripts(n),e.completeLoad(t)}catch(r){e.onError(makeError("importscripts","importScripts failed for "+t+" at "+n,r,[t]))}},isBrowser&&!cfg.skipDataMain&&eachReverse(scripts(),function(e){if(head||(head=e.parentNode),dataMain=e.getAttribute("data-main"))return mainScript=dataMain,cfg.baseUrl||-1!==mainScript.indexOf("!")||(src=mainScript.split("/"),mainScript=src.pop(),subPath=src.length?src.join("/")+"/":"./",cfg.baseUrl=subPath),mainScript=mainScript.replace(jsSuffixRegExp,""),req.jsExtRegExp.test(mainScript)&&(mainScript=dataMain),cfg.deps=cfg.deps?cfg.deps.concat(mainScript):[mainScript],!0}),define=function(e,t,n){var r,i;"string"!=typeof e&&(n=t,t=e,e=null),isArray(t)||(n=t,t=null),!t&&isFunction(n)&&(t=[],n.length&&(n.toString().replace(commentRegExp,commentReplace).replace(cjsRequireRegExp,function(e,n){t.push(n)}),t=(1===n.length?["require"]:["require","exports","module"]).concat(t))),useInteractive&&(r=currentlyAddingScript||getInteractiveScript())&&(e||(e=r.getAttribute("data-requiremodule")),i=contexts[r.getAttribute("data-requirecontext")]),i?(i.defQueue.push([e,t,n]),i.defQueueMap[e]=!0):globalDefQueue.push([e,t,n])},define.amd={jQuery:!0},req.exec=function(text){return eval(text)},req(cfg)}}(this,"undefined"==typeof setTimeout?void 0:setTimeout),define("requireLib",function(){});var global=window=this;setImmediate=function(e){return setTimeout(e,0)},function(e){var t,n=function(){var t=[],n=function(e){return t.push(e),1===t.length},r=function(){var e=t,n=0,r=t.length;for(t=[];n<r;)e[n++]()};if("function"==typeof setImmediate)return function(e){n(e)&&setImmediate(r)};if("object"==typeof process&&process.nextTick)return function(e){n(e)&&process.nextTick(r)};var i=e.MutationObserver||e.WebKitMutationObserver;if(i){var o=1,s=document.createTextNode("");return new i(r).observe(s,{characterData:!0}),function(e){n(e)&&(s.data=o*=-1)}}if(e.postMessage){var a=!0;if(e.attachEvent){var u=function(){a=!1};e.attachEvent("onmessage",u),e.postMessage("__checkAsync","*"),e.detachEvent("onmessage",u)}if(a){var c="__promise"+Math.random()+"_"+new Date,l=function(e){e.data===c&&(e.stopPropagation&&e.stopPropagation(),r())};return e.addEventListener?e.addEventListener("message",l,!0):e.attachEvent("onmessage",l),function(t){n(t)&&e.postMessage(c,"*")}}}var f=e.document;if("onreadystatechange"in f.createElement("script")){var d=function(){var e=f.createElement("script");e.onreadystatechange=function(){e.parentNode.removeChild(e),e=e.onreadystatechange=null,r()},(f.documentElement||f.body).appendChild(e)};return function(e){n(e)&&d()}}return function(e){n(e)&&setTimeout(r,0)}}(),r=function(e){n(function(){throw e})},i=function(e){return"function"==typeof e},o=function(e){return null!==e&&"object"==typeof e},s=Object.prototype.toString,a=Array.isArray||function(e){return"[object Array]"===s.call(e)},u=function(e){for(var t=[],n=0,r=e.length;n<r;)t.push(n++);return t},c=Object.keys||function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t},l=function(e,t){return function(n){e.call(this,n,t)}},f=e.PromiseRejectionEvent?function(t,n){new e.PromiseRejectionEvent("unhandledrejection",{promise:n,reason:t})}:"object"==typeof process&&process.emit?function(e,t){process.emit("unhandledRejection",e,t)}:function(){},d=function(){this._promise=new p};d.prototype={promise:function(){return this._promise},resolve:function(e){this._promise.isResolved()||this._promise._resolve(e)},reject:function(e){this._promise.isResolved()||(v.isPromise(e)?(e=e.then(function(e){var t=v.defer();return t.reject(e),t.promise()}),this._promise._resolve(e)):this._promise._reject(e))},notify:function(e){this._promise.isResolved()||this._promise._notify(e)}};var h={PENDING:0,RESOLVED:1,FULFILLED:2,REJECTED:3},p=function(e){if(this._value=t,this._status=h.PENDING,this._shouldEmitUnhandledRejection=!0,this._fulfilledCallbacks=[],this._rejectedCallbacks=[],this._progressCallbacks=[],e){var n=this,r=e.length;try{e(function(e){n.isResolved()||n._resolve(e)},r>1?function(e){n.isResolved()||n._reject(e)}:t,r>2?function(e){n.isResolved()||n._notify(e)}:t)}catch(e){this._reject(e)}}};p.prototype={valueOf:function(){return this._value},isResolved:function(){return this._status!==h.PENDING},isFulfilled:function(){return this._status===h.FULFILLED},isRejected:function(){return this._status===h.REJECTED},then:function(e,t,n,r){this._shouldEmitUnhandledRejection=!1;var i=new d;return this._addCallbacks(i,e,t,n,r),i.promise()},catch:function(e,n){return this.then(t,e,n)},fail:function(e,n){return this.then(t,e,n)},always:function(e,t){var n=this,r=function(){return e.call(this,n)};return this.then(r,r,t)},progress:function(e,n){return this.then(t,t,e,n)},spread:function(e,t,n){return this.then(function(t){return e.apply(this,t)},t,n)},done:function(e,t,n,i){this.then(e,t,n,i).fail(r)},delay:function(e){var t,n=this.then(function(n){var r=new d;return t=setTimeout(function(){r.resolve(n)},e),r.promise()});return n.always(function(){clearTimeout(t)}),n},timeout:function(e){var t=new d,n=setTimeout(function(){t.reject(new v.TimedOutError("timed out"))},e);return this.then(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise().always(function(){clearTimeout(n)}),t.promise()},_vow:!0,_resolve:function(e){if(!(this._status>h.RESOLVED)){if(e===this)return void this._reject(TypeError("Can't resolve promise with itself"));if(this._status=h.RESOLVED,e&&e._vow)return void(e.isFulfilled()?this._fulfill(e.valueOf()):e.isRejected()?(e._shouldEmitUnhandledRejection=!1,this._reject(e.valueOf())):e.then(this._fulfill,this._reject,this._notify,this));if(o(e)||i(e)){var t;try{t=e.then}catch(e){return void this._reject(e)}if(i(t)){var n=this,r=!1;try{t.call(e,function(e){r||(r=!0,n._resolve(e))},function(e){r||(r=!0,n._reject(e))},function(e){n._notify(e)})}catch(e){r||this._reject(e)}return}}this._fulfill(e)}},_fulfill:function(e){this._status>h.RESOLVED||(this._status=h.FULFILLED,this._value=e,this._callCallbacks(this._fulfilledCallbacks,e),this._fulfilledCallbacks=this._rejectedCallbacks=this._progressCallbacks=t)},_reject:function(e){if(!(this._status>h.RESOLVED)){if(this._status=h.REJECTED,this._value=e,this._callCallbacks(this._rejectedCallbacks,e),!this._rejectedCallbacks.length){var r=this;n(function(){r._shouldEmitUnhandledRejection&&f(e,r)})}this._fulfilledCallbacks=this._rejectedCallbacks=this._progressCallbacks=t}},_notify:function(e){this._callCallbacks(this._progressCallbacks,e)},_addCallbacks:function(e,n,r,o,s){r&&!i(r)?(s=r,r=t):o&&!i(o)&&(s=o,o=t),r&&(this._shouldEmitUnhandledRejection=!1);var a;this.isRejected()||(a={defer:e,fn:i(n)?n:t,ctx:s},this.isFulfilled()?this._callCallbacks([a],this._value):this._fulfilledCallbacks.push(a)),this.isFulfilled()||(a={defer:e,fn:r,ctx:s},this.isRejected()?this._callCallbacks([a],this._value):this._rejectedCallbacks.push(a)),this._status<=h.RESOLVED&&this._progressCallbacks.push({defer:e,fn:o,ctx:s})},_callCallbacks:function(e,t){var r=e.length;if(r){var i=(this.isResolved(),this.isFulfilled()),o=this.isRejected();n(function(){for(var n,s,a,u=0;u<r;)if(n=e[u++],s=n.defer,a=n.fn,a){var c,l=n.ctx;try{c=l?a.call(l,t):a(t)}catch(e){s.reject(e);continue}i||o?s.resolve(c):s.notify(c)}else i?s.resolve(t):o?s.reject(t):s.notify(t)})}}};var g={cast:function(e){return v.cast(e)},all:function(e){return v.all(e)},race:function(e){return v.anyResolved(e)},resolve:function(e){return v.resolve(e)},reject:function(e){return v.reject(e)}};for(var m in g)g.hasOwnProperty(m)&&(p[m]=g[m]);var v={Deferred:d,Promise:p,defer:function(){return new d},when:function(e,t,n,r,i){return v.cast(e).then(t,n,r,i)},fail:function(e,n,r){return v.when(e,t,n,r)},always:function(e,t,n){return v.when(e).always(t,n)},progress:function(e,t,n){return v.when(e).progress(t,n)},spread:function(e,t,n,r){return v.when(e).spread(t,n,r)},done:function(e,t,n,r,i){v.when(e).done(t,n,r,i)},isPromise:function(e){return o(e)&&i(e.then)},cast:function(e){return e&&e._vow?e:v.resolve(e)},valueOf:function(e){return e&&i(e.valueOf)?e.valueOf():e},isFulfilled:function(e){return!e||!i(e.isFulfilled)||e.isFulfilled()},isRejected:function(e){return!(!e||!i(e.isRejected))&&e.isRejected()},isResolved:function(e){return!e||!i(e.isResolved)||e.isResolved()},resolve:function(e){var t=v.defer();return t.resolve(e),t.promise()},fulfill:function(e){var t=v.defer(),n=t.promise();return t.resolve(e),n.isFulfilled()?n:n.then(null,function(e){return e})},reject:function(e){var t=v.defer();return t.reject(e),t.promise()},invoke:function(t,n){var r,i=Math.max(arguments.length-1,0);if(i){r=Array(i);for(var o=0;o<i;)r[o++]=arguments[o]}try{return v.resolve(r?t.apply(e,r):t.call(e))}catch(e){return v.reject(e)}},all:function(e){var t=new d,n=a(e),r=n?u(e):c(e),i=r.length,o=n?[]:{};if(!i)return t.resolve(o),t.promise();var s=i;return v._forEach(e,function(e,n){o[r[n]]=e,--s||t.resolve(o)},t.reject,t.notify,t,r),t.promise()},allResolved:function(e){var t=new d,n=a(e),r=n?u(e):c(e),i=r.length,o=n?[]:{};if(!i)return t.resolve(o),t.promise();var s=function(){--i||t.resolve(e)};return v._forEach(e,s,s,t.notify,t,r),t.promise()},allPatiently:function(e){return v.allResolved(e).then(function(){var t,n,r,i,o=a(e),s=o?u(e):c(e),l=s.length,f=0;if(!l)return o?[]:{};for(;f<l;)r=s[f++],i=e[r],v.isRejected(i)?(t||(t=o?[]:{}),o?t.push(i.valueOf()):t[r]=i.valueOf()):t||((n||(n=o?[]:{}))[r]=v.valueOf(i));if(t)throw t;return n})},any:function(e){var t=new d,n=e.length;if(!n)return t.reject(Error()),t.promise();var r,i=0;return v._forEach(e,t.resolve,function(e){i||(r=e),++i===n&&t.reject(r)},t.notify,t),t.promise()},anyResolved:function(e){var t=new d;return e.length?(v._forEach(e,t.resolve,t.reject,t.notify,t),t.promise()):(t.reject(Error()),t.promise())},delay:function(e,t){return v.resolve(e).delay(t)},timeout:function(e,t){return v.resolve(e).timeout(t)},_forEach:function(e,t,n,r,i,o){for(var s=o?o.length:e.length,a=0;a<s;)v.when(e[o?o[a]:a],l(t,a),n,r,i),++a},TimedOutError:function(e){var t=function(t){this.name=e,this.message=t};return t.prototype=new Error,t}("TimedOut")},y=!0;"object"==typeof module&&"object"==typeof module.exports&&(module.exports=v,y=!1),"object"==typeof modules&&i(modules.define)&&(modules.define("vow",function(e){e(v)}),y=!1),"function"==typeof define&&(define("vow",["require","exports","module"],function(e,t,n){n.exports=v}),y=!1),y&&(e.vow=v)}("undefined"!=typeof window?window:global),define("utils/geom",[],function(){function e(e,t){if(e>=r||e<=0)return{points:t.points.reverse(),segLengths:t.segLengths.reverse()};for(var n=0,r=0;r<e;)r+=t.segLengths[n],n++;var i=1-(r-e)/t.segLengths[n-1],o=t.points[n-1],s=t.points[n];return o&&s?{points:[[o[0]+i*(s[0]-o[0]),o[1]+i*(s[1]-o[1])]].concat(t.points.slice(n)).reverse(),segLengths:[(1-i)*t.segLengths[n-1]].concat(t.segLengths.slice(n)).reverse()}:(console.warn(e,t,n),{points:t.points.reverse(),segLengths:t.segLengths.reverse()})}function t(e,t){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}function n(e){return e.slice(1).map(function(n,r){return t(n,e[r])})}function r(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]);return t?[e[0]/t,e[1]/t]:[0,0]}return{getLength:function(e){return n(e).reduce(function(e,t){return e+t},0)},cut:function(t,r,i){if(r+i==0)return t;var o=n(t),s=o.reduce(function(e,t){return e+t},0);if(r+i==0||0==s)return t;if(r+i>s-1){var a=(s-1)/(r+i);r*=a,i*=a}return e(i,e(r,{points:t,segLengths:o})).points},bounds:function(e){return e.reduce(function(e,t){return(t[0]<e[0][0]||!e[0][0])&&(e[0][0]=t[0]),(t[1]<e[0][1]||!e[0][1])&&(e[0][1]=t[1]),(t[0]>e[1][0]||!e[1][0])&&(e[1][0]=t[0]),(t[1]>e[1][1]||!e[1][1])&&(e[1][1]=t[1]),e},[[],[]])},findIntersectionPos:function(e,t){var n=e[0],r=t[0],i=[e[1][0]-e[0][0],e[1][1]-e[0][1]],o=[t[1][0]-t[0][0],t[1][1]-t[0][1]];return((n[1]-r[1])*o[0]-(n[0]-r[0])*o[1])/(i[0]*o[1]-i[1]*o[0])},roundAngle:function(e,n,r,o){var s=[(n[0]-e[0])/t(e,n),(n[1]-e[1])/t(e,n)],a=[(r[0]-n[0])/t(n,r),(r[1]-n[1])/t(n,r)],u=[a[0]*s[0]+a[1]*s[1],-a[0]*s[1]+a[1]*s[0]],c=u[1],l=u[0],f=Math.sign(c),d=f*Math.acos(l),h=Math.sqrt((1-l)/2),p=Math.sqrt((1+l)/2),g=Math.min(t(e,n),t(n,r),o*h/p);o=g*p/h;var m=[f*s[1]*o,-f*s[0]*o],v=[n[0]-s[0]*g,n[1]-s[1]*g],y=[v[0]-m[0],v[1]-m[1]],b=Math.abs(Math.round(2*Math.PI*d/1)),w=d/b;if(b<1)return[e,n,r];var x=[n[0]+a[0]*g,n[1]+a[1]*g],O=Math.sin(w),_=Math.cos(w),E=[e];for(t(v,e)>1e-5&&E.push(v),i=1;i<b-1;i++)m=[m[0]*_-m[1]*O,m[0]*O+m[1]*_],E.push([y[0]+m[0],y[1]+m[1]]);return t(x,r)>1e-5&&E.push(x),E.push(r),E},deduplicate:function(e){return e.filter(function(e,t,n){return e!==n[t-1]})},offsetLine:function(e,t){var n=[],o=e.length-1,s=[],a=[];for(i=0;i<o;i++)if(s[i]=r([e[i+1][0]-e[i][0],e[i+1][1]-e[i][1]]),i>0){var u=r([s[i-1][0]+s[i][0],s[i-1][1]+s[i][1]]);a[i]=[-u[1],u[0]]}for(n.push([e[0][0]-s[0][1]*t,e[0][1]+s[0][0]*t]),i=1;i<o;i++){var c=s[i][0]*a[i][1]-s[i][1]*a[i][0],l=t*Math.min(1/c,3);n.push([e[i][0]+a[i][0]*l,e[i][1]+a[i][1]*l])}return n.push([e[o][0]-s[o-1][1]*t,e[o][1]+s[o-1][0]*t]),n}}}),define("utils/date",{findNearestDate:function(e,t,n){var r=e.sort(function(e,t){return+new Date(e)-+new Date(t)}).filter(function(e){return n?+new Date(e)<t:+new Date(e)<=t});return r[r.length-1]}}),define("utils/route",[],function(){var e={strip:function(e){return e.replace(/^[-<>]/,"")},getType:function(t){return t=e.strip(t),t.indexOf("Тб")?t.indexOf("Тм")?"bus":"tram":"trolley"},clearType:function(t){return e.strip(t).replace(/^(Тб|Тм) /,"")},notPhantom:function(e){return"-"!=e[0]},inverse:function(e){return e.replace(/^</,"%").replace(/^>/,"<").replace(/^%/,">")},inverseList:function(t,n){return n||(n=-1),n<0?t.map(e.inverse).reverse():t}};return e}),define("utils/extend",[],function(){var e=function(e){return e.call.bind(e)}(Object.prototype.hasOwnProperty);return function(t){"object"!=typeof t&&(t={});for(var n=1,r=arguments.length;n<r;n++){var i=arguments[n];if(i)for(var o in i)e(i,o)&&(t[o]=i[o])}return t}}),define("utils/cache",["utils/extend"],function(e){var t=function(e){this._capacity=e,this._storage={},this._order=[]};return e(t.prototype,{_buildKey:function(){return JSON.stringify([].slice.apply(arguments))},set:function(){var e=[].slice.apply(arguments),t=e.pop(),n=this._buildKey.apply(this,e);this._order.length==this._capacity&&(console.log("cache exceeded",this._capacity),delete this._storage[this._order.shift()]),this._order.push(n),this._storage[n]=t},get:function(){return this._storage[this._buildKey.apply(this,arguments)]},has:function(){return this._buildKey.apply(this,arguments)in this._storage},drop:function(){this._storage={},this._order=[]}}),t}),define("utils/file",[],function(){return{getActualsFileNameByState:function(e,t){if(t)var n=Object.keys(Object.keys(t).reduce(function(e,n){return Object.keys(t[n]).forEach(function(t){e[t]=!0}),e},{})).sort(),r=e.timeSettings.date,i=n.filter(function(e){return+new Date(e)<r}),o=+new Date(i[i.length-1]);return[new Date(o||e.timeSettings.date||void 0).toISOString().substring(0,10),e.timeSettings.dow,e.timeSettings.fromHour,e.timeSettings.toHour,e.widthFactor,e.customColoringId].join("-")}}}),define("data/actuals/routes",["vow","utils/date"],function(e,t){return{shouldRecalc:function(e,t){return-1!=t.indexOf("timeSettings")},calc:function(n,r){return e.resolve(Object.keys(n.routes).reduce(function(e,i){var o=n.routes[i]||[];return e[i]=o[t.findNearestDate(Object.keys(o),r.timeSettings.date)]||[],e},{}))}}}),define("data/actuals/existing-routes",["vow","utils/route"],function(e,t){return{shouldRecalc:function(e,t){return-1!=t.indexOf("timeSettings")},deps:["routes"],calc:function(n,r,i){return e.resolve(Object.keys(Object.keys(i).reduce(function(e,n){return i[n].forEach(function(n){e[t.strip(n)]=!0}),e
},{})))}}}),define("data/actuals/widths",["vow"],function(e){return{shouldRecalc:function(e,t){return!0},deps:["existingRoutes"],calc:function(t,n,r){return e.resolve(r.reduce(function(e,r){var o=t.freqs[r]||{};return currentDay=Object.keys(o).filter(function(e){return e&n.timeSettings.dow}),tt=o[currentDay]||{},i=0,n.isEqualWidthsMode?e[r]=2:1==n.selectedRoutes.length?e[r]=r==n.selectedRoutes[0]?20:0:(e[r]=Object.keys(tt).reduce(function(e,t){return t>=n.timeSettings.fromHour&&t<=n.timeSettings.toHour&&(e+=tt[t],i++),e},0)/i,n.selectedRoutes.length&&-1==n.selectedRoutes.indexOf(r)&&(e[r]=0)),e[r]*=n.widthFactor,e[r]=Math.round(100*e[r])/100||e[r],e},{}))}}}),define("utils/bus-color",[],function(){function e(e){var t=e[0]-Math.floor(e[0]),n=e[1],r=e[2];if(!n)return[r,r,r];t*=6;var i=Math.floor(t),o=[1-n,1-n*(t-i),1-n*(1-(t-i)),1];return[[3,2,0],[1,3,0],[0,3,2],[0,1,3],[2,0,3],[3,0,1]][i].map(function(e){return r*o[e]})}function t(e){return r=256*e[0]|0,g=256*e[1]|0,b=256*e[2]|0,"#"+("0"+r.toString(16)).substr(-2)+("0"+g.toString(16)).substr(-2)+("0"+b.toString(16)).substr(-2)}function n(e,t,n){var r=t+e*(n-t);return r-Math.floor(r)}function i(r){r+="";var i=2,o=!1;-1!=r.indexOf("Тб")&&(r=r.substr(3),i=1),-1!=r.indexOf("Тм")&&(r=r.substr(3),i=0),-1!=r.indexOf("э")&&(r=r.replace(/э/g,""),i=3),/.?[a-я]$/.test(r)&&(r=r.substr(0,r.length-1),o=!0),r=+r.replace(/^[^\d]/g,""),isNaN(r)&&(r=0);var s=[(r+2)%11/10,.09+r/16%4*.2,.48+r%5*.09];switch(i){case 0:s[0]=n(s[0],-.1,.05),s[1]=n(s[1],.75,1),s[2]=n(s[2],1-3*(s[1]-.75),1);break;case 1:s[0]=n(s[0],.2,.4),s[1]=n(s[1],.7+.3*Math.abs(s[0]-.3),1),s[2]=n(s[2],.3,1);break;case 2:s[0]=n(s[0],.4+s[1]/4,1-s[1]/4),s[1]=n(s[1],0,1-.5*Math.abs(s[0]-.8)),s[2]=n(s[2],0,1-.3*Math.abs(s[0]-.8));break;case 3:s[0]=n(s[0],.1,.14),s[1]=n(s[1],.9,1),s[2]=n(s[2],1-2*(s[1]-.75),1)}return o&&(s[1]=n(s[1],0,.9),s[2]=n(s[2],.3,1)),t(e(s))}return i});var PROJECT_ROUTES=["Т79","Т3","Т47","Т10","Б","Т39","Т67","Т40","Т71","Т72","Т52","м9","24к","м1","648","64","223","205к","247","164","237","24","763к","209","232","651","271","Т15","633","298","709","683","Т25","215к","85","132","291","263","м6","791","832","834","241","789","615","221","м3","275","706к","811","м2","608","155","805","659","230","690","31","А","39","761","216","255","645","51","299","806","776","803","742","152","194","С5","276","706","116","С8","700","52","171","159","84к","257","12","39к","67","57","672","84","130","143","800","763","40","96","9","м10","656","709к","179","623","142","101","730","8","186","820","153","701","278","147","106","220","38","214","В"];define("data/colorings/default",["utils/bus-color"],function(e){return{getRouteColor:function(t,n,r){var i=n.registry&&n.registry[t]&&n.registry[t].express;return e(t+(i?"э":""))},getSegmentOutlines:function(e,t,n){return null},getRouteOutlines:function(e,t,n,r){return null},shouldRecalcColorsOn:["timeSettings"],shouldRecalcOutlinesOn:[]}}),define("data/colorings/type",[],function(){return{getRouteColor:function(e,t,n){return-1!=e.indexOf("Тм")?"#e44":-1!=e.indexOf("Тб")?"#7c3":"#47c"},getSegmentOutlines:function(e,t,n){return null},getRouteOutlines:function(e,t,n,r){return null},shouldRecalcColorsOn:["timeSettings"],shouldRecalcOutlinesOn:[]}}),define("data/colorings/black",[],function(){return{getRouteColor:function(e,t,n){return"#000"},getSegmentOutlines:function(e,t,n){return null},getRouteOutlines:function(e,t,n,r){return null},shouldRecalcColorsOn:["timeSettings"],shouldRecalcOutlinesOn:[]}}),define("data/colorings/vendor",[],function(){return{getRouteColor:function(e,t,n){return t.registry&&t.registry[e]&&{autoline:"#59c",tmp20:"#871",alphagrant:"#d22",rico:"#1bf",gepart:"#528",gortaxi:"#ff2",autocars:"#000",transway:"#f0f"}[t.registry[e].vendor]||"#ddd"},getSegmentOutlines:function(e,t,n){return null},getRouteOutlines:function(e,t,n,r){return null},shouldRecalcColorsOn:["timeSettings"],shouldRecalcOutlinesOn:[]}}),define("data/trolley",[],function(){var e={isSegmentInRoute:function(e,t,n){var r=n[e];return r&&(-1!=r.indexOf(">"+t)||-1!=r.indexOf("<"+t)||-1!=r.indexOf(t))},isSegmentTrolleyForRoute:function(e,t,n,r){e=+e;var i=n[e],o=i&&-1!=i.indexOf(">"+t),s=i&&-1!=i.indexOf("<"+t),a=i&&-1!=i.indexOf(t),u=-1!=r.forward.indexOf(e),c=-1!=r.backward.indexOf(e),l=-1!=r.both.indexOf(e);return o&&s&&(a=!0),a&&(o=!1,s=!1),o&&(u||l)||s&&(c||l)||a&&l},getTrolleyFraction:function(t,n,r,i){var o=0,s=0;return Object.keys(n).forEach(function(a){if(e.isSegmentInRoute(a,t,r)){var u=r[a].reduce(function(e,n){return n==t?e+2:n==">"+t||n=="<"+t?e+1:e},0);o+=u*n[a],e.isSegmentTrolleyForRoute(a,t,r,i)&&(s+=u*n[a])}}),s/o}};return e}),define("data/colorings/troll-project",["data/trolley"],function(e){return{getRouteColor:function(t,n,r,i){var o=e.getTrolleyFraction(t,i.lengths,i.actualRoutes,n.trolleyWires),s=0,a=0;return Object.keys(i.lengths).forEach(function(r){if(e.isSegmentInRoute(r,t,i.actualRoutes)){var o=i.actualRoutes[r].reduce(function(e,n){return n==t?e+2:n==">"+t||n=="<"+t?e+1:e},0);s+=o*i.lengths[r],e.isSegmentTrolleyForRoute(r,t,i.actualRoutes,n.trolleyWires)&&(a+=o*i.lengths[r])}}),-1!=t.indexOf("Тм")?"#f84":-1!=t.indexOf("Тб")?"#4d2":"rgb("+Math.round(34*o)+","+Math.round(187*o)+","+Math.round(255*o)+")"},getRouteOutlines:function(t,n,r,i,o){return e.isSegmentTrolleyForRoute(t,n,o.actualRoutes,r.trolleyWires)?"#af5":"#999"},getSegmentOutlines:function(t,n,r,i){if(1==r.selectedRoutes.length){var o=r.selectedRoutes[0];return e.isSegmentInRoute(t,o,i.actualRoutes)?e.isSegmentTrolleyForRoute(t,o,i.actualRoutes,n.trolleyWires)?{10:{color:"#af5",avoidEmpty:!0}}:{10:{color:"#999",avoidEmpty:!0}}:null}},shouldRecalcColorsOn:["timeSettings"],shouldRecalcOutlinesOn:["timeSettings","selectedRoutes"]}}),define("data/colorings/wires",[],function(){return{getRouteColor:function(e,t,n,r){return-1!=e.indexOf("Тм")?"#f84":-1!=e.indexOf("Тб")?"#1bf":"#528"},getSegmentOutlines:function(e,t,n,r){return-1!=t.trolleyWires.both.indexOf(e)?{10:"#6f0"}:-1!=t.trolleyWires.forward.indexOf(e)?{5:{color:"#6f0",offset:5}}:-1!=t.trolleyWires.backward.indexOf(e)?{5:{color:"#6f0",offset:-5}}:null},getRouteOutlines:function(e,t,n,r){return null},shouldRecalcColorsOn:["timeSettings"],shouldRecalcOutlinesOn:["timeSettings"]}}),define("data/actuals/colors",["vow","data/colorings/default","data/colorings/type","data/colorings/black","data/colorings/vendor","data/colorings/troll-project","data/colorings/wires"],function(e,t,n,r,i,o,s){var a={default:t,type:n,black:r,vendor:i,"troll-project":o,wires:s};return{shouldRecalc:function(e,t){var n=a[e.customColoringId||"default"];return-1!=t.indexOf("customColoringId")||n.shouldRecalcColorsOn.some(function(e){return-1!=t.indexOf(e)})},deps:["widths","routes","existingRoutes","lengths"],calc:function(t,n,r,i,o,s){var u=a[n.customColoringId||"default"];return e.resolve(o.reduce(function(e,o){return e[o]=u.getRouteColor(o,t,n,{actualWidths:r,actualRoutes:i,lengths:s}),e},{}))}}}),define("data/actuals/outlines",["vow","data/colorings/default","data/colorings/type","data/colorings/black","data/colorings/vendor","data/colorings/troll-project","data/colorings/wires"],function(e,t,n,r,i,o,s){var a={default:t,type:n,black:r,vendor:i,"troll-project":o,wires:s};return{shouldRecalc:function(e,t){var n=a[e.customColoringId||"default"];return-1!=t.indexOf("customColoringId")||n.shouldRecalcOutlinesOn.some(function(e){return-1!=t.indexOf(e)})},deps:["widths","routes"],calc:function(t,n,r,i){var o=a[n.customColoringId||"default"];return e.resolve(Object.keys(t.segments).reduce(function(e,s){return e[+s]=o.getSegmentOutlines(+s,t,n,{actualWidths:r,actualRoutes:i}),e},{}))}}}),define("data/actuals/route-outlines",["vow","utils/route","data/colorings/default","data/colorings/type","data/colorings/black","data/colorings/vendor","data/colorings/troll-project","data/colorings/wires"],function(e,t,n,r,i,o,s,a){var u={default:n,type:r,black:i,vendor:o,"troll-project":s,wires:a};return{shouldRecalc:function(e,t){var n=u[e.customColoringId||"default"];return-1!=t.indexOf("customColoringId")||n.shouldRecalcOutlinesOn.some(function(e){return-1!=t.indexOf(e)})},deps:["widths","routes"],calc:function(n,r,i,o){var s=u[r.customColoringId||"default"];return e.resolve(Object.keys(n.segments).reduce(function(e,a){var u=(o[a]||[]).reduce(function(e,u){var c=t.strip(u);return e[c]=s.getRouteOutlines(+a,c,n,r,{actualWidths:i,actualRoutes:o}),e},{}),c=Object.keys(u)[0],l=Object.keys(u).some(function(e){return u[e]!=u[c]});return e[+a]=l?u:u[c]||null,e},{}))}}}),define("data/actuals/max-width",["vow","utils/route"],function(e,t){return{shouldRecalc:function(e,t){return!0},deps:["widths","routes"],calc:function(n,r,i,o){return e.resolve(n.segments.reduce(function(e,n,r){if(n.length){var s=(o[r]||[]).reduce(function(e,n){return e+(i[t.strip(n)]||0)},0);return Math.max(s,e)}},0))}}}),define("utils/junction",["utils/geom","utils/route"],function(e,t){counter=0;var n={getEndPointKey:function(e){return Math.round(2e3*e[0])+"_"+Math.round(1e3*e[1])},getEndPointByKey:function(e){return[e.split("_")[0]/2e3,e.split("_")[1]/1e3]},getRoutePassingModes:function(e,n){var r={},i=e.reduce(function(e,r){var i=(n[Math.abs(r)]||[]).filter(t.notPhantom);return r<0&&(i=i.map(function(e,t){return e.replace(">","%").replace("<",">").replace("%","<")}).reverse()),e[r]=i,e},{}),o=function(t,n){return e.filter(function(e){return e!==n&&1==i[e].filter(function(e){return e===t}).length})};return e.forEach(function(e){var n=i[e].map(function(e,t){return e.replace(">","%").replace("<",">").replace("%","<")}).reverse();n.forEach(function(i){var s=t.strip(i);if(!r[s])if(0==i.indexOf("<")||0==i.indexOf(">"))if(n.filter(function(e){return t.strip(e)==s}).length>1)r[s]={type:"strange"};else{var a=o(i,e),u=o((">"==i[0]?"<":">")+s,e),c=o(s,e);if(u.length>0)r[s]={type:"strange"};else if(1==a.length&&1==c.length){var l={};l[c[0]]=[{to:e,as:(">"==i[0]?"<":">")+s},{to:a[0],as:i}],l[e]=[{to:c[0],as:s}],l[a[0]]=[{to:c[0],as:s}],r[s]={type:"splitting",ways:l}}else if(1==a.length&&0==c.length){var l={};l[e]=[{to:a[0],as:i}],l[a[0]]=[{to:e,as:(">"==i[0]?"<":">")+s}],r[s]={type:"passing",ways:l}}else r[s]={type:"strange"}}else if(n.filter(function(e){return e==">"+s||e=="<"+s}).length>0)r[s]={type:"strange"};else if(1==n.filter(function(e){return e==s}).length){var f=o(">"+s,e),d=o("<"+s,e),c=o(s,e);if(0==f.length&&0==d.length&&0==c.length)r[s]={type:"ending"};else if(0==f.length&&0==d.length&&1==c.length)l={},l[e]=[{to:c[0],as:s}],l[c[0]]=[{to:e,as:s}],r[s]={type:"passing",ways:l};else if(0==f.length&&0==d.length&&2==c.length){var l={};l[c[0]]=[{to:c[1],as:s},{to:e,as:s}],l[c[1]]=[{to:c[0],as:s},{to:e,as:s}],l[e]=[{to:c[0],as:s},{to:c[1],as:s}],r[s]={type:"3-way",ways:l}}else if(1==f.length&&1==d.length&&f[0]!=d[0]&&0==c.length){var l={};l[e]=[{to:d[0],as:"<"+s},{to:f[0],as:">"+s}],l[d[0]]=[{to:e,as:"<"+s}],l[d[0]]=[{to:e,as:">"+s}],r[s]={type:"splitting",ways:l}}else r[s]={type:"strange"}}else if(n.filter(function(e){return e==s}).length=2)if(0==o(s,e).length&&0==o(">"+s,e).length&&0==o("<"+s,e).length){var l={};l[e]=[{to:e,as:s}],r[s]={type:"u-turn",ways:l}}else r[s]={type:"strange"};else r[s]={type:"strange"}})}),r},extractJunctionRouteGroups:function(e,r,i){function o(e,n,r){var i=u[t.strip(r)],o=i&&i.ways&&i.ways[e]&&i.ways[e].filter(function(e){return e.to===n})[0];return!!o&&o.as}function s(e){return e.reduce(function(e,n){return e+(i[t.strip(n)]||0)},0)}var a=[],u=n.getRoutePassingModes(e,r),c=Object.keys(u).filter(function(e){return"ending"==u[e].type||"u-turn"==u[e].type||"strange"==u[e].type});return e.forEach(function(n,i){var u=t.inverseList(r[Math.abs(n)]||[],-n),c=s(u);e.slice(i+1).forEach(function(e){for(var i=t.inverseList(r[Math.abs(e)]||[],e),l=s(i),f=0,d=0,h=null,p=0,g=0;f<u.length;){if(h){if(t.notPhantom(u[f])&&i[d]==o(n,e,u[f])){var m=i[d].length>u[f].length?i[d]:u[f];h.push(m),f++,d++;continue}var v=s(h);a.push({from:n,to:e,routes:h,fromShift:p+v/2-c/2,toShift:g+v/2-l/2,groupWidth:v}),h=null}if(t.notPhantom(u[f]))if(o(n,e,u[f])){if(-1===(d=i.indexOf(o(n,e,u[f])))){console.warn("couldn't find",o(n,e,u[f]),"among",JSON.stringify(i)),f++;continue}h=[],p=s(u.slice(0,f)),g=s(i.slice(0,d))}else f++;else f++}if(h){var v=s(h);a.push({from:n,to:e,routes:h,fromShift:p+v/2-c/2,toShift:g+v/2-l/2,groupWidth:v})}})}),c.length&&e.forEach(function(e){for(var n=0,i=r[Math.abs(e)]||[],o=s(i),u=null,l=0;n<i.length;){if(u){if(t.notPhantom(i[n])&&-1!=c.indexOf(t.strip(i[n]))){u.push(t.strip(i[n])),n++;continue}var f=s(u);a.push({from:e,routes:u,fromShift:l+f/2-o/2,groupWidth:f}),u=null}t.notPhantom(i[n])?-1==c.indexOf(t.strip(i[n]))?n++:(u=[],l=s(i.slice(0,n))):n++}}),a.sort(function(e,t){return t.groupWidth-e.groupWidth}),a},getJunctionLineGeometry:function(t,n,r,i,o,s){var a=e.deduplicate(e.offsetLine(r,o)),u=e.deduplicate(e.offsetLine(i,s)),c=[a[a.length-2],a[a.length-1]],l=e.getLength(c),f=[u[0],u[1]],d=e.getLength(f),h=c[1],p=f[0],g=[h,[h[0]+(c[1][0]-c[0][0])/l,h[1]+(c[1][1]-c[0][1])/l]],m=[p,[p[0]-(f[1][0]-f[0][0])/d,p[1]-(f[1][1]-f[0][1])/d]],v=e.findIntersectionPos(g,m),y=e.findIntersectionPos(m,g);if(v>0&&y>0){var b=[h[0]+(g[1][0]-g[0][0])*v,h[1]+(g[1][1]-g[0][1])*v];return e.deduplicate(e.roundAngle(h,b,p,t))}var w=[-(c[1][1]-c[0][1])/l,(c[1][0]-c[0][0])/l],x=[-(f[1][1]-f[0][1])/d,(f[1][0]-f[0][0])/d],O=Math.max(e.findIntersectionPos(g,[n,[n[0]+w[0],n[1]+w[1]]]),t/10),_=Math.max(e.findIntersectionPos(m,[n,[n[0]+x[0],n[1]+x[1]]]),t/10),E=[h[0]+(g[1][0]-g[0][0])*O/3,h[1]+(g[1][1]-g[0][1])*O/3],M=[p[0]+(m[1][0]-m[0][0])*_/3,p[1]+(m[1][1]-m[0][1])*_/3],j=[(E[0]+M[0])/2,(E[1]+M[1])/2];return e.deduplicate([].concat(e.roundAngle(h,E,j,t)).concat(e.roundAngle(j,M,p,t)))}};return n}),define("data/actuals/junctions",["vow","utils/junction","utils/route"],function(e,t,n){return{shouldRecalc:function(e,t){return!0},deps:["routes","widths"],calc:function(r,i,o,s){var a=r.segments,u=Object.keys(a).reduce(function(e,n){var r=a[n][0],i=a[n][a[n].length-1];return(e[t.getEndPointKey(r)]||(e[t.getEndPointKey(r)]=[])).push(n),(e[t.getEndPointKey(i)]||(e[t.getEndPointKey(i)]=[])).push(-n),e},{}),c=Object.keys(u).reduce(function(e,t){return e[t]=Math.min(Math.max(u[t].reduce(function(e,t){return Math.max(e,(o[Math.abs(t)]||[]).reduce(function(e,t){return e+(s[n.strip(t)]||0)},0))},0),10),100),e},{}),l=Object.keys(u).reduce(function(e,n){var r=t.extractJunctionRouteGroups(u[n],o,s);return r.length&&(e[n]=r),e},{});return e.resolve(Object.keys(l).reduce(function(e,t){return e[t]={size:c[t],routeGroups:l[t]},e},{}))}}}),define("data/actuals/route-bounds",["vow","utils/route","utils/geom"],function(e,t,n){return{shouldRecalc:function(e,t){return-1!=t.indexOf("timeSettings")},deps:["routes"],calc:function(r,i,o){return e.resolve(r.segments.reduce(function(e,i,s){return(o[s]||[]).forEach(function(i){var o=n.bounds(r.segments[s]);routeBounds=e[t.strip(i)],routeBounds?e[t.strip(i)]=[[Math.min(o[0][0],routeBounds[0][0]),Math.min(o[0][1],routeBounds[0][1])],[Math.max(o[1][0],routeBounds[1][0]),Math.max(o[1][1],routeBounds[1][1])]]:e[t.strip(i)]=o}),e},{}))}}}),define("utils/wgs-84",[],function(){function e(e,t,n){return e-Math.floor((e-t)/(n-t))*(n-t)}function t(t){var n=Math.max(Math.min(t[1],90-a),-90+a)*o,s=i*Math.sin(n);return[r*e(t[0]*o,-Math.PI,Math.PI),r*Math.log(Math.tan(.25*Math.PI+.5*n)/Math.pow(Math.tan(.25*Math.PI+.5*Math.asin(s)),i))]}function n(e){var t=.5*Math.PI-2*Math.atan(1/Math.exp(e*d));return(t+h*Math.sin(2*t)+p*Math.sin(4*t)+g*Math.sin(6*t)+m*Math.sin(8*t))*s}var r=6378137,i=.0818191908426,o=Math.PI/180,s=180/Math.PI,a=1e-10,u=i*i,c=u*u,l=c*u,f=c*c,d=1/r,h=u/2+5*c/24+l/12+13*f/360,p=7*c/48+29*l/240+811*f/11520,g=7*l/120+81*f/1120,m=4279*f/161280,v=2*Math.PI*r,y=(Math.sqrt(1-u),1/v),b=v/2,w=0,x=256*y;return{fromGlobalPixels:function(t,r){return r!=w&&(x=Math.pow(2,r+8)*y,w=r),[e(Math.PI*t[0]/Math.pow(2,r+7)-Math.PI,-Math.PI,Math.PI)*s,n(b-t[1]/x)]},toGlobalPixels:function(e,n){n!=w&&(x=Math.pow(2,n+8)*y,w=n);var r=t(e);return[(b+r[0])*x,(b-r[1])*x]}}}),define("data/actuals/lengths",["vow","utils/geom","utils/wgs-84"],function(e,t,n){return{shouldRecalc:function(){return!1},deps:[],calc:function(r){return e.resolve(r.segments.reduce(function(e,r,i){return e[i]=Math.round(t.getLength(r.map(function(e){return n.toGlobalPixels(e,20)}))),e},{}))}}}),define("data/calc-actuals",["vow","utils/extend","utils/date","data/actuals/routes","data/actuals/existing-routes","data/actuals/widths","data/actuals/colors","data/actuals/outlines","data/actuals/route-outlines","data/actuals/max-width","data/actuals/junctions","data/actuals/route-bounds","data/actuals/lengths"],function(e,t,n,r,i,o,s,a,u,c,l,f,d){function h(e,t){var n,r,i=[];return Array.isArray(e)?(n=e,r=!1):(n=t[e].deps||[],r=e),n.forEach(function(e){i.push.apply(i,h(e,t))}),r&&i.push(r),i.filter(function(e,t){return-1===i.slice(0,t).indexOf(e)})}return function(n,p,g,m){var v=e.defer(),y={routes:r,existingRoutes:i,widths:o,colors:s,outlines:a,routeOutlines:u,maxWidth:c,junctions:l,routeBounds:f,lengths:d},b=Object.keys(y).filter(function(e){return!m[e]||y[e].shouldRecalc(p,g)}),w={};return b=h(b,y),b.forEach(function(t,r){w[t]=e.all((y[t].deps||[]).map(function(e){return-1!=b.indexOf(e)?w[e]:m[e]})).then(function(e){return y[t].calc.apply(y[t],[n,p].concat(e))}),v.notify((r+1)/b.length)}),e.all(w).then(function(e){v.notify(1),v.resolve(t(m,e))}),v.promise()}}),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define("flatbush",t):e.flatbush=t()}(this,function(){"use strict";function e(e,t,n){if(void 0===e)throw new Error("Missing required argument: numItems.");this._numItems=e,this._nodeSize=t||16,n=n||Float64Array;for(var r=e,i=r,o=1;i+=r=Math.ceil(r/this._nodeSize),o++,1!==r;);this.data=new n(5*i),this._hilbertValues=new Uint32Array(e),this._levelBoundaries=new Uint32Array(o),this._numAdded=0,this._pos=0,this._minX=1/0,this._minY=1/0,this._maxX=-1/0,this._maxY=-1/0}function t(e,t){for(var n=0,r=t.length-1;n<r;){var i=n+r>>1;t[i]>e?r=i:n=i+1}return t[n]}function n(e,t,n,r){var i=e[n];e[n]=e[r],e[r]=i;var o=5*n,s=5*r,a=t[o],u=t[o+1],c=t[o+2],l=t[o+3],f=t[o+4];t[o]=t[s],t[o+1]=t[s+1],t[o+2]=t[s+2],t[o+3]=t[s+3],t[o+4]=t[s+4],t[s]=a,t[s+1]=u,t[s+2]=c,t[s+3]=l,t[s+4]=f}function r(e,t){var n=e^t,r=65535^n,i=65535^(e|t),o=e&(65535^t),s=n|r>>1,a=n>>1^n,u=i>>1^r&o>>1^i,c=n&i>>1^o>>1^o;a=(n=s)&(r=a)>>2^r&(n^r)>>2,u^=n&(i=u)>>2^r&(o=c)>>2,c^=r&i>>2^(n^r)&o>>2,a=(n=s=n&n>>2^r&r>>2)&(r=a)>>4^r&(n^r)>>4,u^=n&(i=u)>>4^r&(o=c)>>4,c^=r&i>>4^(n^r)&o>>4,u^=(n=s=n&n>>4^r&r>>4)&(i=u)>>8^(r=a)&(o=c)>>8;var l=e^t,f=(r=(c^=r&i>>8^(n^r)&o>>8)^c>>1)|65535^(l|(n=u^u>>1));return((f=1431655765&((f=858993459&((f=252645135&((f=16711935&(f|f<<8))|f<<4))|f<<2))|f<<1))<<1|(l=1431655765&((l=858993459&((l=252645135&((l=16711935&(l|l<<8))|l<<4))|l<<2))|l<<1)))>>>0}return e.prototype={add:function(e,t,n,r){this.data[this._pos++]=this._numAdded++,this.data[this._pos++]=e,this.data[this._pos++]=t,this.data[this._pos++]=n,this.data[this._pos++]=r,e<this._minX&&(this._minX=e),t<this._minY&&(this._minY=t),n>this._maxX&&(this._maxX=n),r>this._maxY&&(this._maxY=r)},finish:function(){if(this._numAdded!==this._numItems)throw new Error("Added "+this._numAdded+" items when expected "+this._numItems);for(var e=this._maxX-this._minX,t=this._maxY-this._minY,i=0;i<this._numItems;i++){var o=Math.floor(65535*(this.data[5*i+1]-this._minX)/e),s=Math.floor(65535*(this.data[5*i+2]-this._minY)/t);this._hilbertValues[i]=r(o,s)}!function e(t,r,i,o){if(!(i>=o)){for(var s=t[i],a=i-1,u=o+1;;){for(;t[++a]<s;);for(;t[--u]>s;);if(a>=u)break;n(t,r,a,u)}e(t,r,i,u),e(t,r,u+1,o)}}(this._hilbertValues,this.data,0,this._numItems-1);var a=0,u=this._numItems,c=0;do{var l=a+5*u;for(u=Math.ceil(u/this._nodeSize),this._levelBoundaries[c++]=this._pos;a<l;){var f=1/0,d=1/0,h=-1/0,p=-1/0,g=a;for(i=0;i<this._nodeSize&&a<l;i++){a++;var m=this.data[a++],v=this.data[a++],y=this.data[a++],b=this.data[a++];m<f&&(f=m),v<d&&(d=v),y>h&&(h=y),b>p&&(p=b)}this.data[this._pos++]=g,this.data[this._pos++]=f,this.data[this._pos++]=d,this.data[this._pos++]=h,this.data[this._pos++]=p}}while(1!==u);this._levelBoundaries[c++]=this._pos},search:function(e,n,r,i,o){if(0===this._levelBoundaries[0])throw new Error("Data not yet indexed - call index.finish().");for(var s=this.data.length-5,a=[],u=[];void 0!==s;){for(var c=t(s,this._levelBoundaries),l=0;l<this._nodeSize;l++){var f=s+5*l;if(l>0&&f>=c)break;var d=this.data[f++];if(!(r<this.data[f++]||i<this.data[f++]||e>this.data[f++]||n>this.data[f++]))if(s<5*this._numItems){var h=!0;void 0!==o&&(h=o(d)),h&&u.push(d)}else a.push(d)}s=a.pop()}return u}},function(t,n,r){return new e(t,n,r)}}),define("worker/commands/init",["utils/geom","utils/date","utils/route","utils/cache","utils/file","data/calc-actuals","flatbush","vow"],function(e,t,n,r,i,o,s,a){return function(t){var n=a.defer(),u=this.state=t.state,c=t.segments,l=this.data={segments:c,freqs:t.freqs,routes:t.routes,registry:t.registry,trolleyWires:t.trolleyWires},f=this.tree=s(c.length);return c.forEach(function(t,r){var i=e.bounds(t);n.notify(r/c.length*.5),f.add(i[0][0],i[0][1],i[1][0],i[1][1])}),f.finish(),fetch("actuals/"+i.getActualsFileNameByState(u,l.routes)+".json").then(function(e){if(200!=e.status)throw new Error;return e.json()}).catch(function(e){return o(l,u,Object.keys(u),{})}).then(function(e){this.actuals=e,this.tilePixelLinesCache=new r(400)},function(e){throw e},function(e){n.notify(.5+e/2)},this).then(function(){n.resolve({state:"ready"})}),n.promise()}}),define("worker/utils/tile-utils",["utils/geom","utils/wgs-84"],function(e,t){return{TILE_SIZE:256,getSegmentIdsByTile:function(e,t,n,r){var i=this.tileToGeoBounds(e,t,n,r);return global.tree.search(i[0][0],i[0][1],i[1][0],i[1][1])},offsetLine:function(t,n){return e.offsetLine(t,n)},getZoomFactor:function(e){return 1/(e>15?.5:16-e)},tileToGlobalPixelBounds:function(e,t,n){return[256*e,256*t,256*(e+1),256*(t+1)]},geoPointToTilePixels:function(e,n,r,i){var o=t.toGlobalPixels(e.slice().reverse(),i);return[o[0]-256*n,o[1]-256*r]},tilePixelsToGeoPoint:function(e,n,r,i){var o=[e[0]+256*n,e[1]+256*r];return t.fromGlobalPixels(o,i).reverse()},tileToGeoBounds:function(e,n,r,i){i=i||0;var o=this.tileToGlobalPixelBounds(e,n,r);return[t.fromGlobalPixels([o[0]-i,o[3]+i],r).reverse(),t.fromGlobalPixels([o[2]+i,o[1]-i],r).reverse()]},geoBoundsToTiles:function(e,n){var r=[t.toGlobalPixels([e[0][1],e[0][0]],n),t.toGlobalPixels([e[1][1],e[1][0]],n)];return{minX:Math.floor(r[0][0]/256),maxY:Math.floor(r[0][1]/256),maxX:Math.floor(r[1][0]/256),minY:Math.floor(r[1][1]/256)}}}}),define("worker/renderer/renderer",["utils/geom","utils/route","utils/junction","utils/cache","utils/wgs-84","worker/utils/tile-utils"],function(e,t,n,r,i,o){function s(e){return _[e]||(_[e]=new r(O))}function a(e){return E[e]||(E[e]=new r(O))}function u(e){return M[e]||(M[e]=new r(O))}function c(e){return j[e]||(j[e]=new r(O))}function l(e){var t=(global.actuals.junctions,global.data.segments[Math.abs(e)]);return[actuals.junctions[n.getEndPointKey(t[0])],actuals.junctions[n.getEndPointKey(t[t.length-1])]]}function f(t,n){var r=global.data,s=o.getZoomFactor(t),a=l(n);return e.cut(r.segments[n].map(function(e){return i.toGlobalPixels([e[1],e[0]],t)}),a[0]?s*a[0].size:0,a[1]?s*a[1].size:0)}function d(e,t){var n=s(e).get(t);return n||s(e).set(t,n=f(e,t)),n}function h(e,t,r,s,a,u){var c=global.data;return zoomWidthFactor=o.getZoomFactor(e),toSegment=c.segments[Math.abs(r)],junctionGeoPoint=toSegment[r>0?0:toSegment.length-1],junctionPixelPoint=i.toGlobalPixels([junctionGeoPoint[1],junctionGeoPoint[0]],e),fromSegmentMultiline=d(e,Math.abs(t)),toSegmentMultiline=d(e,Math.abs(r)),t>0&&(fromSegmentMultiline=fromSegmentMultiline.slice().reverse()),r<0&&(toSegmentMultiline=toSegmentMultiline.slice().reverse()),n.getJunctionLineGeometry(zoomWidthFactor*u,junctionPixelPoint,fromSegmentMultiline,toSegmentMultiline,zoomWidthFactor*s,zoomWidthFactor*a)}function p(t,n){var r=global.actuals,i=r.junctions[n],o=[];return i.routeGroups.forEach(function(n){var r=n.from,s=n.to;if(s){var a=h(t,r,s,n.fromShift,n.toShift,i.size),u=e.getLength(a);o.push({geometry:e.cut(a,u/2+x,x),routes:n.routes,segment:Math.abs(s)},{geometry:e.cut(a,x,u/2+x),routes:n.routes,segment:Math.abs(r)})}}),o}function g(e,t){var n=a(e).get(t);return n||a(e).set(t,n=p(e,t)),n}function m(e){var t=global.actuals;return Object.keys(e.reduce(function(e,r){var i=global.data.segments[r],o=n.getEndPointKey(i[0]),s=n.getEndPointKey(i[i.length-1]);return t.junctions[o]&&(e[o]=!0),t.junctions[s]&&(e[s]=!0),e},{}))}function v(e,t,n){return o.getSegmentIdsByTile(e,t,n,o.getZoomFactor(n)*global.actuals.maxWidth)}function y(n,r){var i=global.actuals,s=i.widths,a=(i.colors,r.routes),u=o.getZoomFactor(n),c=0,l=0;a.some(function(e){if(t.notPhantom(e))return!0;c+=s[t.strip(e)]||0}),c*=u,a.slice(0).reverse().some(function(e){if(t.notPhantom(e))return!0;l+=s[t.strip(e)]||0}),l*=u;var f=(c-l)/2,d=a.reduce(function(e,n){return e+(s[t.strip(n)]||0)},0)*u;return[{coords:e.offsetLine(r.geometry,f*u),width:d-c-l,segment:r.segment}]}function b(n,r){var i=global.actuals,s=r.geometry,a=r.segment,u=r.routes,c=i.widths,l=o.getZoomFactor(n),f=u.reduce(function(e,n){return e+(c[t.strip(n)]||0)},0)*l,d=-f/2,h=[];return u.forEach(function(n){var r=c[t.strip(n)]*l||0;if(d+=r/2,t.notPhantom(n)){var i=e.offsetLine(s,d);h.push({coords:i,width:r,route:t.strip(n),arrowDirection:">"==n[0]?1:"<"==n[0]?-1:0,segment:a})}d+=r/2}),h}function w(e,t,n,r){var i=global.actuals,o=v(e,t,n),s="hotspots"==r?c(n):u(n),a=o.filter(function(e){return s.has(e)}),l=o.filter(function(e){return!s.has(e)}),f=m(l),h=a.reduce(function(e,t){return e.concat(s.get(t))},[]),p=f.reduce(function(e,t){return e.concat(g(n,t))},[]);return l.forEach(function(e){var t=[{segment:e,geometry:d(n,e),routes:i.routes[e]||[]}].concat(p.filter(function(t){return t.segment==e})),o=t.reduce(function(e,t){return e.concat("hotspots"===r?y(n,t):b(n,t))},[]);s.set(e,o),h.push.apply(h,o)}),h}var x=1e-5,O=1e5,_={},E={},M={},j={};return{renderTile:function(e,n,r){var i=global.actuals,o=i.colors;i.outlineColors;return w(e,n,r).map(function(e){var n=i.routeOutlines[e.segment];return n&&"object"==typeof n&&(n=n[t.strip(e.route)]),{coords:e.coords,color:o[t.strip(e.route)]||"#ccc",outlineColor:n,outlineWidth:0,width:e.width,arrowDirection:e.arrowDirection,arrowGap:Math.max(30/e.width,10),data:{id:e.segment,route:e.route}}})},renderHotspots:function(e,t,n){return w(e,t,n,"hotspots").map(function(e){return{coords:e.coords,color:"#000",data:{id:e.segment},width:e.width,dashStyle:[],lineCap:"butt",dashOffset:0}})},dropCaches:function(){_={},_={},E={},M={},j={}}}}),define("worker/commands/setup",["vow","data/calc-actuals","utils/route","utils/file","worker/renderer/renderer"],function(e,t,n,r,i){return function(n,o){postMessage({state:"busy",progress:0});var s=e.defer(),a=n.state,u=this.state,c=this.data,l=Object.keys(a).reduce(function(e,t){return JSON.stringify(u[t])!=JSON.stringify(a[t])&&e.push(t),e},[]);return this.state=a,fetch("actuals/"+r.getActualsFileNameByState(a,c.routes)+".json").then(function(e){if(200!=e.status)throw new Error;return e.json()}).catch(function(e){return t(c,a,l,this.actuals)}).then(function(e){this.actuals=e,i.dropCaches(),s.resolve({state:"ready",key:o})},function(e){throw e},function(e){s.notify(e)},this),s.promise()}}),define("worker/renderer/renderLine",[],function(){var e=function(t,n,r,i,o){var s=n.coords,a=n.width,u=n.color,c=n.outlineColor,l=n.outlineWidth;if(o=o||1,l&&c&&t.unshift.apply(t,[{cmd:"beginPath"},{cmd:"moveTo",args:[(s[0][0]-r)*o,(s[0][1]-i)*o]}].concat(s.slice(1).map(function(e){return{cmd:"lineTo",args:[(e[0]-r)*o,(e[1]-i)*o]}})).concat([{prop:"strokeStyle",val:c},{prop:"lineWidth",val:(a+2*l)*o},{prop:"lineCap",val:"butt"},{cmd:"stroke"}])),n.arrowDirection){var f=n.arrowLength||1.5,d=n.arrowWidth||3,h=n.arrowGap||4,p=Math.max(Math.ceil(d*n.width/2),2);e(t,{coords:s,width:a,color:u},r,i,o);for(var g=d;g>0;g-=1/p)e(t,{coords:s,width:g*a,color:u,lineCap:"butt",dashStyle:[a*(f*(d-g)),a*(f*g+h)],dashOffset:1==n.arrowDirection?a*(h/2):-a*(g*f+h/2)},r,i,o)}else a>0&&(t.push({cmd:"beginPath"},{cmd:"moveTo",args:[(s[0][0]-r)*o,(s[0][1]-i)*o]}),s.slice(1).forEach(function(e){t.push({cmd:"lineTo",args:[(e[0]-r)*o,(e[1]-i)*o]})}),t.push({prop:"strokeStyle",val:u},{prop:"lineWidth",val:a*o}),t.push({prop:"lineCap",val:n.lineCap||"round"}),n.dashStyle?t.push({prop:"lineDashOffset",val:n.dashOffset?n.dashOffset*o:0},{cmd:"setLineDash",args:[n.dashStyle&&n.dashStyle.map(function(e){return e*o})]}):t.push({cmd:"setLineDash",args:[[]]}),t.push({cmd:"stroke"}));return t};return e}),define("worker/commands/renderTile",["vow","utils/extend","worker/utils/tile-utils","worker/renderer/renderer","worker/renderer/renderLine"],function(e,t,n,r,i){return function(o,s){var a=[],u=o.x,c=o.y,l=o.z,f=o.devicePixelRatio||1,d=o.routes,h=o.style||{};return e.resolve(r.renderTile.call(this,u,c,l)).then(function(e){return d&&(e=e.filter(function(e){return-1!=d.indexOf(e.data.route)})),e.forEach(function(e){i(a,t({},e,h),u*n.TILE_SIZE,c*n.TILE_SIZE,f)}),{result:a,key:s}})}}),define("worker/commands/renderHotspots",["vow","worker/renderer/renderer","worker/utils/tile-utils"],function(e,t,n){return function(n,r){var i=[],o=n.x,s=n.y,a=n.z;return e.resolve(t.renderHotspots(o,s,a)).then(function(e){return e.forEach(function(e){e.coords;i.push({shape:{type:"LineString",pixelGeometry:e.coords,params:{strokeWidth:e.width+this.state.isTouch?10:0}},feature:{properties:{segmentId:e.data.id}}})}),{result:i,key:r}})}}),define("worker/commands/getActuals",["vow"],function(e){return function(t,n){return e.resolve({result:{state:this.state,actuals:this.actuals},key:n})}});var global=window=this;setImmediate=function(e){return setTimeout(e,0)},void 0===define&&importScripts("//cdnjs.cloudflare.com/ajax/libs/require.js/2.3.2/require.min.js"),requirejs.config({paths:{vow:"//cdn.rawgit.com/dfilatov/vow/0.4.17/lib/vow",flatbush:"//unpkg.com/flatbush@1.3.0/flatbush.min"}}),require(["vow","worker/commands/init","worker/commands/setup","worker/commands/renderTile","worker/commands/renderHotspots","worker/commands/getActuals"],function(e,t,n,r,i,o){var s={init:t,setup:n,renderTile:r,renderHotspots:i,getActuals:o};this.addEventListener("message",function(e){var t=e.data,n=this;s[t.command]?s[t.command].call(this,t.params,t.key).then(function(e){e&&n.postMessage(e)},function(e){console.warn(e)},function(e){n.postMessage({progress:e})}):console.warn('no command "'+t.command+'" defined')}),this.postMessage({state:"instantiated"})}),define("worker",function(){});