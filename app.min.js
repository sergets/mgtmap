/** vim: et:ts=4:sw=4:sts=4
 * @license RequireJS 2.3.5 Copyright jQuery Foundation and other contributors.
 * Released under MIT license, https://github.com/requirejs/requirejs/blob/master/LICENSE
 */

/**
 * @module vow
 * @author Filatov Dmitry <dfilatov@yandex-team.ru>
 * @version 0.4.17
 * @license
 * Dual licensed under the MIT and GPL licenses:
 *   * http://www.opensource.org/licenses/mit-license.php
 *   * http://www.gnu.org/licenses/gpl.html
 */

var requirejs,require,define;!function(global,setTimeout){function commentReplace(e,t){return t||""}function isFunction(e){return"[object Function]"===ostring.call(e)}function isArray(e){return"[object Array]"===ostring.call(e)}function each(e,t){if(e){var n;for(n=0;n<e.length&&(!e[n]||!t(e[n],n,e));n+=1);}}function eachReverse(e,t){if(e){var n;for(n=e.length-1;n>-1&&(!e[n]||!t(e[n],n,e));n-=1);}}function hasProp(e,t){return hasOwn.call(e,t)}function getOwn(e,t){return hasProp(e,t)&&e[t]}function eachProp(e,t){var n;for(n in e)if(hasProp(e,n)&&t(e[n],n))break}function mixin(e,t,n,i){return t&&eachProp(t,function(t,r){!n&&hasProp(e,r)||(!i||"object"!=typeof t||!t||isArray(t)||isFunction(t)||t instanceof RegExp?e[r]=t:(e[r]||(e[r]={}),mixin(e[r],t,n,i)))}),e}function bind(e,t){return function(){return t.apply(e,arguments)}}function scripts(){return document.getElementsByTagName("script")}function defaultOnError(e){throw e}function getGlobal(e){if(!e)return e;var t=global;return each(e.split("."),function(e){t=t[e]}),t}function makeError(e,t,n,i){var r=new Error(t+"\nhttp://requirejs.org/docs/errors.html#"+e);return r.requireType=e,r.requireModules=i,n&&(r.originalError=n),r}function newContext(e){function t(e){var t,n;for(t=0;t<e.length;t++)if("."===(n=e[t]))e.splice(t,1),t-=1;else if(".."===n){if(0===t||1===t&&".."===e[2]||".."===e[t-1])continue;t>0&&(e.splice(t-1,2),t-=2)}}function n(e,n,i){var r,s,o,a,u,c,l,d,h,f,g,p=n&&n.split("/"),m=R.map,v=m&&m["*"];if(e&&(e=e.split("/"),c=e.length-1,R.nodeIdCompat&&jsSuffixRegExp.test(e[c])&&(e[c]=e[c].replace(jsSuffixRegExp,"")),"."===e[0].charAt(0)&&p&&(g=p.slice(0,p.length-1),e=g.concat(e)),t(e),e=e.join("/")),i&&m&&(p||v)){s=e.split("/");e:for(o=s.length;o>0;o-=1){if(u=s.slice(0,o).join("/"),p)for(a=p.length;a>0;a-=1)if((r=getOwn(m,p.slice(0,a).join("/")))&&(r=getOwn(r,u))){l=r,d=o;break e}!h&&v&&getOwn(v,u)&&(h=getOwn(v,u),f=o)}!l&&h&&(l=h,d=f),l&&(s.splice(0,d,l),e=s.join("/"))}return getOwn(R.pkgs,e)||e}function i(e){isBrowser&&each(scripts(),function(t){if(t.getAttribute("data-requiremodule")===e&&t.getAttribute("data-requirecontext")===b.contextName)return t.parentNode.removeChild(t),!0})}function r(e){var t=getOwn(R.paths,e);if(t&&isArray(t)&&t.length>1)return t.shift(),b.require.undef(e),b.makeRequire(null,{skipMap:!0})([e]),!0}function s(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function o(e,t,i,r){var o,a,u,c,l=null,d=t?t.name:null,h=e,f=!0,g="";return e||(f=!1,e="_@r"+(q+=1)),c=s(e),l=c[0],e=c[1],l&&(l=n(l,d,r),a=getOwn(C,l)),e&&(l?g=i?e:a&&a.normalize?a.normalize(e,function(e){return n(e,d,r)}):-1===e.indexOf("!")?n(e,d,r):e:(g=n(e,d,r),c=s(g),l=c[0],g=c[1],i=!0,o=b.nameToUrl(g))),u=!l||a||i?"":"_unnormalized"+(I+=1),{prefix:l,name:g,parentMap:t,unnormalized:!!u,url:o,originalName:h,isDefine:f,id:(l?l+"!"+g:g)+u}}function a(e){var t=e.id,n=getOwn(S,t);return n||(n=S[t]=new b.Module(e)),n}function u(e,t,n){var i=e.id,r=getOwn(S,i);!hasProp(C,i)||r&&!r.defineEmitComplete?(r=a(e),r.error&&"error"===t?n(r.error):r.on(t,n)):"defined"===t&&n(C[i])}function c(e,t){var n=e.requireModules,i=!1;t?t(e):(each(n,function(t){var n=getOwn(S,t);n&&(n.error=e,n.events.error&&(i=!0,n.emit("error",e)))}),i||req.onError(e))}function l(){globalDefQueue.length&&(each(globalDefQueue,function(e){var t=e[0];"string"==typeof t&&(b.defQueueMap[t]=!0),M.push(e)}),globalDefQueue=[])}function d(e){delete S[e],delete O[e]}function h(e,t,n){var i=e.map.id;e.error?e.emit("error",e.error):(t[i]=!0,each(e.depMaps,function(i,r){var s=i.id,o=getOwn(S,s);!o||e.depMatched[r]||n[s]||(getOwn(t,s)?(e.defineDep(r,C[s]),e.check()):h(o,t,n))}),n[i]=!0)}function f(){var e,t,n=1e3*R.waitSeconds,s=n&&b.startTime+n<(new Date).getTime(),o=[],a=[],u=!1,l=!0;if(!_){if(_=!0,eachProp(O,function(e){var n=e.map,c=n.id;if(e.enabled&&(n.isDefine||a.push(e),!e.error))if(!e.inited&&s)r(c)?(t=!0,u=!0):(o.push(c),i(c));else if(!e.inited&&e.fetched&&n.isDefine&&(u=!0,!n.prefix))return l=!1}),s&&o.length)return e=makeError("timeout","Load timeout for modules: "+o,null,o),e.contextName=b.contextName,c(e);l&&each(a,function(e){h(e,{},{})}),s&&!t||!u||!isBrowser&&!isWebWorker||x||(x=setTimeout(function(){x=0,f()},50)),_=!1}}function g(e){hasProp(C,e[0])||a(o(e[0],null,!0)).init(e[1],e[2])}function p(e,t,n,i){e.detachEvent&&!isOpera?i&&e.detachEvent(i,t):e.removeEventListener(n,t,!1)}function m(e){var t=e.currentTarget||e.srcElement;return p(t,b.onScriptLoad,"load","onreadystatechange"),p(t,b.onScriptError,"error"),{node:t,id:t&&t.getAttribute("data-requiremodule")}}function v(){var e;for(l();M.length;){if(e=M.shift(),null===e[0])return c(makeError("mismatch","Mismatched anonymous define() module: "+e[e.length-1]));g(e)}b.defQueueMap={}}var _,y,b,w,x,R={waitSeconds:7,baseUrl:"./",paths:{},bundles:{},pkgs:{},shim:{},config:{}},S={},O={},E={},M=[],C={},j={},k={},q=1,I=1;return w={require:function(e){return e.require?e.require:e.require=b.makeRequire(e.map)},exports:function(e){if(e.usingExports=!0,e.map.isDefine)return e.exports?C[e.map.id]=e.exports:e.exports=C[e.map.id]={}},module:function(e){return e.module?e.module:e.module={id:e.map.id,uri:e.map.url,config:function(){return getOwn(R.config,e.map.id)||{}},exports:e.exports||(e.exports={})}}},y=function(e){this.events=getOwn(E,e.id)||{},this.map=e,this.shim=getOwn(R.shim,e.id),this.depExports=[],this.depMaps=[],this.depMatched=[],this.pluginMaps={},this.depCount=0},y.prototype={init:function(e,t,n,i){i=i||{},this.inited||(this.factory=t,n?this.on("error",n):this.events.error&&(n=bind(this,function(e){this.emit("error",e)})),this.depMaps=e&&e.slice(0),this.errback=n,this.inited=!0,this.ignore=i.ignore,i.enabled||this.enabled?this.enable():this.check())},defineDep:function(e,t){this.depMatched[e]||(this.depMatched[e]=!0,this.depCount-=1,this.depExports[e]=t)},fetch:function(){if(!this.fetched){this.fetched=!0,b.startTime=(new Date).getTime();var e=this.map;if(!this.shim)return e.prefix?this.callPlugin():this.load();b.makeRequire(this.map,{enableBuildCallback:!0})(this.shim.deps||[],bind(this,function(){return e.prefix?this.callPlugin():this.load()}))}},load:function(){var e=this.map.url;j[e]||(j[e]=!0,b.load(this.map.id,e))},check:function(){if(this.enabled&&!this.enabling){var e,t,n=this.map.id,i=this.depExports,r=this.exports,s=this.factory;if(this.inited){if(this.error)this.emit("error",this.error);else if(!this.defining){if(this.defining=!0,this.depCount<1&&!this.defined){if(isFunction(s)){if(this.events.error&&this.map.isDefine||req.onError!==defaultOnError)try{r=b.execCb(n,s,i,r)}catch(t){e=t}else r=b.execCb(n,s,i,r);if(this.map.isDefine&&void 0===r&&(t=this.module,t?r=t.exports:this.usingExports&&(r=this.exports)),e)return e.requireMap=this.map,e.requireModules=this.map.isDefine?[this.map.id]:null,e.requireType=this.map.isDefine?"define":"require",c(this.error=e)}else r=s;if(this.exports=r,this.map.isDefine&&!this.ignore&&(C[n]=r,req.onResourceLoad)){var o=[];each(this.depMaps,function(e){o.push(e.normalizedMap||e)}),req.onResourceLoad(b,this.map,o)}d(n),this.defined=!0}this.defining=!1,this.defined&&!this.defineEmitted&&(this.defineEmitted=!0,this.emit("defined",this.exports),this.defineEmitComplete=!0)}}else hasProp(b.defQueueMap,n)||this.fetch()}},callPlugin:function(){var e=this.map,t=e.id,i=o(e.prefix);this.depMaps.push(i),u(i,"defined",bind(this,function(i){var r,s,l,h=getOwn(k,this.map.id),f=this.map.name,g=this.map.parentMap?this.map.parentMap.name:null,p=b.makeRequire(e.parentMap,{enableBuildCallback:!0});return this.map.unnormalized?(i.normalize&&(f=i.normalize(f,function(e){return n(e,g,!0)})||""),s=o(e.prefix+"!"+f,this.map.parentMap,!0),u(s,"defined",bind(this,function(e){this.map.normalizedMap=s,this.init([],function(){return e},null,{enabled:!0,ignore:!0})})),void((l=getOwn(S,s.id))&&(this.depMaps.push(s),this.events.error&&l.on("error",bind(this,function(e){this.emit("error",e)})),l.enable()))):h?(this.map.url=b.nameToUrl(h),void this.load()):(r=bind(this,function(e){this.init([],function(){return e},null,{enabled:!0})}),r.error=bind(this,function(e){this.inited=!0,this.error=e,e.requireModules=[t],eachProp(S,function(e){0===e.map.id.indexOf(t+"_unnormalized")&&d(e.map.id)}),c(e)}),r.fromText=bind(this,function(n,i){var s=e.name,u=o(s),l=useInteractive;i&&(n=i),l&&(useInteractive=!1),a(u),hasProp(R.config,t)&&(R.config[s]=R.config[t]);try{req.exec(n)}catch(e){return c(makeError("fromtexteval","fromText eval for "+t+" failed: "+e,e,[t]))}l&&(useInteractive=!0),this.depMaps.push(u),b.completeLoad(s),p([s],r)}),void i.load(e.name,p,r,R))})),b.enable(i,this),this.pluginMaps[i.id]=i},enable:function(){O[this.map.id]=this,this.enabled=!0,this.enabling=!0,each(this.depMaps,bind(this,function(e,t){var n,i,r;if("string"==typeof e){if(e=o(e,this.map.isDefine?this.map:this.map.parentMap,!1,!this.skipMap),this.depMaps[t]=e,r=getOwn(w,e.id))return void(this.depExports[t]=r(this));this.depCount+=1,u(e,"defined",bind(this,function(e){this.undefed||(this.defineDep(t,e),this.check())})),this.errback?u(e,"error",bind(this,this.errback)):this.events.error&&u(e,"error",bind(this,function(e){this.emit("error",e)}))}n=e.id,i=S[n],hasProp(w,n)||!i||i.enabled||b.enable(e,this)})),eachProp(this.pluginMaps,bind(this,function(e){var t=getOwn(S,e.id);t&&!t.enabled&&b.enable(e,this)})),this.enabling=!1,this.check()},on:function(e,t){var n=this.events[e];n||(n=this.events[e]=[]),n.push(t)},emit:function(e,t){each(this.events[e],function(e){e(t)}),"error"===e&&delete this.events[e]}},b={config:R,contextName:e,registry:S,defined:C,urlFetched:j,defQueue:M,defQueueMap:{},Module:y,makeModuleMap:o,nextTick:req.nextTick,onError:c,configure:function(e){if(e.baseUrl&&"/"!==e.baseUrl.charAt(e.baseUrl.length-1)&&(e.baseUrl+="/"),"string"==typeof e.urlArgs){var t=e.urlArgs;e.urlArgs=function(e,n){return(-1===n.indexOf("?")?"?":"&")+t}}var n=R.shim,i={paths:!0,bundles:!0,config:!0,map:!0};eachProp(e,function(e,t){i[t]?(R[t]||(R[t]={}),mixin(R[t],e,!0,!0)):R[t]=e}),e.bundles&&eachProp(e.bundles,function(e,t){each(e,function(e){e!==t&&(k[e]=t)})}),e.shim&&(eachProp(e.shim,function(e,t){isArray(e)&&(e={deps:e}),!e.exports&&!e.init||e.exportsFn||(e.exportsFn=b.makeShimExports(e)),n[t]=e}),R.shim=n),e.packages&&each(e.packages,function(e){var t,n;e="string"==typeof e?{name:e}:e,n=e.name,t=e.location,t&&(R.paths[n]=e.location),R.pkgs[n]=e.name+"/"+(e.main||"main").replace(currDirRegExp,"").replace(jsSuffixRegExp,"")}),eachProp(S,function(e,t){e.inited||e.map.unnormalized||(e.map=o(t,null,!0))}),(e.deps||e.callback)&&b.require(e.deps||[],e.callback)},makeShimExports:function(e){function t(){var t;return e.init&&(t=e.init.apply(global,arguments)),t||e.exports&&getGlobal(e.exports)}return t},makeRequire:function(t,r){function s(n,i,u){var l,d,h;return r.enableBuildCallback&&i&&isFunction(i)&&(i.__requireJsBuild=!0),"string"==typeof n?isFunction(i)?c(makeError("requireargs","Invalid require call"),u):t&&hasProp(w,n)?w[n](S[t.id]):req.get?req.get(b,n,t,s):(d=o(n,t,!1,!0),l=d.id,hasProp(C,l)?C[l]:c(makeError("notloaded",'Module name "'+l+'" has not been loaded yet for context: '+e+(t?"":". Use require([])")))):(v(),b.nextTick(function(){v(),h=a(o(null,t)),h.skipMap=r.skipMap,h.init(n,i,u,{enabled:!0}),f()}),s)}return r=r||{},mixin(s,{isBrowser:isBrowser,toUrl:function(e){var i,r=e.lastIndexOf("."),s=e.split("/")[0],o="."===s||".."===s;return-1!==r&&(!o||r>1)&&(i=e.substring(r,e.length),e=e.substring(0,r)),b.nameToUrl(n(e,t&&t.id,!0),i,!0)},defined:function(e){return hasProp(C,o(e,t,!1,!0).id)},specified:function(e){return e=o(e,t,!1,!0).id,hasProp(C,e)||hasProp(S,e)}}),t||(s.undef=function(e){l();var n=o(e,t,!0),r=getOwn(S,e);r.undefed=!0,i(e),delete C[e],delete j[n.url],delete E[e],eachReverse(M,function(t,n){t[0]===e&&M.splice(n,1)}),delete b.defQueueMap[e],r&&(r.events.defined&&(E[e]=r.events),d(e))}),s},enable:function(e){getOwn(S,e.id)&&a(e).enable()},completeLoad:function(e){var t,n,i,s=getOwn(R.shim,e)||{},o=s.exports;for(l();M.length;){if(n=M.shift(),null===n[0]){if(n[0]=e,t)break;t=!0}else n[0]===e&&(t=!0);g(n)}if(b.defQueueMap={},i=getOwn(S,e),!t&&!hasProp(C,e)&&i&&!i.inited){if(!(!R.enforceDefine||o&&getGlobal(o)))return r(e)?void 0:c(makeError("nodefine","No define call for "+e,null,[e]));g([e,s.deps||[],s.exportsFn])}f()},nameToUrl:function(e,t,n){var i,r,s,o,a,u,c,l=getOwn(R.pkgs,e);if(l&&(e=l),c=getOwn(k,e))return b.nameToUrl(c,t,n);if(req.jsExtRegExp.test(e))a=e+(t||"");else{for(i=R.paths,r=e.split("/"),s=r.length;s>0;s-=1)if(o=r.slice(0,s).join("/"),u=getOwn(i,o)){isArray(u)&&(u=u[0]),r.splice(0,s,u);break}a=r.join("/"),a+=t||(/^data\:|^blob\:|\?/.test(a)||n?"":".js"),a=("/"===a.charAt(0)||a.match(/^[\w\+\.\-]+:/)?"":R.baseUrl)+a}return R.urlArgs&&!/^blob\:/.test(a)?a+R.urlArgs(e,a):a},load:function(e,t){req.load(b,e,t)},execCb:function(e,t,n,i){return t.apply(i,n)},onScriptLoad:function(e){if("load"===e.type||readyRegExp.test((e.currentTarget||e.srcElement).readyState)){interactiveScript=null;var t=m(e);b.completeLoad(t.id)}},onScriptError:function(e){var t=m(e);if(!r(t.id)){var n=[];return eachProp(S,function(e,i){0!==i.indexOf("_@r")&&each(e.depMaps,function(e){if(e.id===t.id)return n.push(i),!0})}),c(makeError("scripterror",'Script error for "'+t.id+(n.length?'", needed by: '+n.join(", "):'"'),e,[t.id]))}}},b.require=b.makeRequire(),b}function getInteractiveScript(){return interactiveScript&&"interactive"===interactiveScript.readyState?interactiveScript:(eachReverse(scripts(),function(e){if("interactive"===e.readyState)return interactiveScript=e}),interactiveScript)}var req,s,head,baseElement,dataMain,src,interactiveScript,currentlyAddingScript,mainScript,subPath,version="2.3.5",commentRegExp=/\/\*[\s\S]*?\*\/|([^:"'=]|^)\/\/.*$/gm,cjsRequireRegExp=/[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,jsSuffixRegExp=/\.js$/,currDirRegExp=/^\.\//,op=Object.prototype,ostring=op.toString,hasOwn=op.hasOwnProperty,isBrowser=!("undefined"==typeof window||"undefined"==typeof navigator||!window.document),isWebWorker=!isBrowser&&"undefined"!=typeof importScripts,readyRegExp=isBrowser&&"PLAYSTATION 3"===navigator.platform?/^complete$/:/^(complete|loaded)$/,defContextName="_",isOpera="undefined"!=typeof opera&&"[object Opera]"===opera.toString(),contexts={},cfg={},globalDefQueue=[],useInteractive=!1;if(void 0===define){if(void 0!==requirejs){if(isFunction(requirejs))return;cfg=requirejs,requirejs=void 0}void 0===require||isFunction(require)||(cfg=require,require=void 0),req=requirejs=function(e,t,n,i){var r,s,o=defContextName;return isArray(e)||"string"==typeof e||(s=e,isArray(t)?(e=t,t=n,n=i):e=[]),s&&s.context&&(o=s.context),r=getOwn(contexts,o),r||(r=contexts[o]=req.s.newContext(o)),s&&r.configure(s),r.require(e,t,n)},req.config=function(e){return req(e)},req.nextTick=void 0!==setTimeout?function(e){setTimeout(e,4)}:function(e){e()},require||(require=req),req.version=version,req.jsExtRegExp=/^\/|:|\?|\.js$/,req.isBrowser=isBrowser,s=req.s={contexts:contexts,newContext:newContext},req({}),each(["toUrl","undef","defined","specified"],function(e){req[e]=function(){var t=contexts[defContextName];return t.require[e].apply(t,arguments)}}),isBrowser&&(head=s.head=document.getElementsByTagName("head")[0],(baseElement=document.getElementsByTagName("base")[0])&&(head=s.head=baseElement.parentNode)),req.onError=defaultOnError,req.createNode=function(e,t,n){var i=e.xhtml?document.createElementNS("http://www.w3.org/1999/xhtml","html:script"):document.createElement("script");return i.type=e.scriptType||"text/javascript",i.charset="utf-8",i.async=!0,i},req.load=function(e,t,n){var i,r=e&&e.config||{};if(isBrowser)return i=req.createNode(r,t,n),i.setAttribute("data-requirecontext",e.contextName),i.setAttribute("data-requiremodule",t),!i.attachEvent||i.attachEvent.toString&&i.attachEvent.toString().indexOf("[native code")<0||isOpera?(i.addEventListener("load",e.onScriptLoad,!1),i.addEventListener("error",e.onScriptError,!1)):(useInteractive=!0,i.attachEvent("onreadystatechange",e.onScriptLoad)),i.src=n,r.onNodeCreated&&r.onNodeCreated(i,r,t,n),currentlyAddingScript=i,baseElement?head.insertBefore(i,baseElement):head.appendChild(i),currentlyAddingScript=null,i;if(isWebWorker)try{setTimeout(function(){},0),importScripts(n),e.completeLoad(t)}catch(i){e.onError(makeError("importscripts","importScripts failed for "+t+" at "+n,i,[t]))}},isBrowser&&!cfg.skipDataMain&&eachReverse(scripts(),function(e){if(head||(head=e.parentNode),dataMain=e.getAttribute("data-main"))return mainScript=dataMain,cfg.baseUrl||-1!==mainScript.indexOf("!")||(src=mainScript.split("/"),mainScript=src.pop(),subPath=src.length?src.join("/")+"/":"./",cfg.baseUrl=subPath),mainScript=mainScript.replace(jsSuffixRegExp,""),req.jsExtRegExp.test(mainScript)&&(mainScript=dataMain),cfg.deps=cfg.deps?cfg.deps.concat(mainScript):[mainScript],!0}),define=function(e,t,n){var i,r;"string"!=typeof e&&(n=t,t=e,e=null),isArray(t)||(n=t,t=null),!t&&isFunction(n)&&(t=[],n.length&&(n.toString().replace(commentRegExp,commentReplace).replace(cjsRequireRegExp,function(e,n){t.push(n)}),t=(1===n.length?["require"]:["require","exports","module"]).concat(t))),useInteractive&&(i=currentlyAddingScript||getInteractiveScript())&&(e||(e=i.getAttribute("data-requiremodule")),r=contexts[i.getAttribute("data-requirecontext")]),r?(r.defQueue.push([e,t,n]),r.defQueueMap[e]=!0):globalDefQueue.push([e,t,n])},define.amd={jQuery:!0},req.exec=function(text){return eval(text)},req(cfg)}}(this,"undefined"==typeof setTimeout?void 0:setTimeout),define("requireLib",function(){}),function(e){var t,n=function(){var t=[],n=function(e){return t.push(e),1===t.length},i=function(){var e=t,n=0,i=t.length;for(t=[];n<i;)e[n++]()};if("function"==typeof setImmediate)return function(e){n(e)&&setImmediate(i)};if("object"==typeof process&&process.nextTick)return function(e){n(e)&&process.nextTick(i)};var r=e.MutationObserver||e.WebKitMutationObserver;if(r){var s=1,o=document.createTextNode("");return new r(i).observe(o,{characterData:!0}),function(e){n(e)&&(o.data=s*=-1)}}if(e.postMessage){var a=!0;if(e.attachEvent){var u=function(){a=!1};e.attachEvent("onmessage",u),e.postMessage("__checkAsync","*"),e.detachEvent("onmessage",u)}if(a){var c="__promise"+Math.random()+"_"+new Date,l=function(e){e.data===c&&(e.stopPropagation&&e.stopPropagation(),i())};return e.addEventListener?e.addEventListener("message",l,!0):e.attachEvent("onmessage",l),function(t){n(t)&&e.postMessage(c,"*")}}}var d=e.document;if("onreadystatechange"in d.createElement("script")){var h=function(){var e=d.createElement("script");e.onreadystatechange=function(){e.parentNode.removeChild(e),e=e.onreadystatechange=null,i()},(d.documentElement||d.body).appendChild(e)};return function(e){n(e)&&h()}}return function(e){n(e)&&setTimeout(i,0)}}(),i=function(e){n(function(){throw e})},r=function(e){return"function"==typeof e},s=function(e){return null!==e&&"object"==typeof e},o=Object.prototype.toString,a=Array.isArray||function(e){return"[object Array]"===o.call(e)},u=function(e){for(var t=[],n=0,i=e.length;n<i;)t.push(n++);return t},c=Object.keys||function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t},l=function(e,t){return function(n){e.call(this,n,t)}},d=e.PromiseRejectionEvent?function(t,n){new e.PromiseRejectionEvent("unhandledrejection",{promise:n,reason:t})}:"object"==typeof process&&process.emit?function(e,t){process.emit("unhandledRejection",e,t)}:function(){},h=function(){this._promise=new g};h.prototype={promise:function(){return this._promise},resolve:function(e){this._promise.isResolved()||this._promise._resolve(e)},reject:function(e){this._promise.isResolved()||(v.isPromise(e)?(e=e.then(function(e){var t=v.defer();return t.reject(e),t.promise()}),this._promise._resolve(e)):this._promise._reject(e))},notify:function(e){this._promise.isResolved()||this._promise._notify(e)}};var f={PENDING:0,RESOLVED:1,FULFILLED:2,REJECTED:3},g=function(e){if(this._value=t,this._status=f.PENDING,this._shouldEmitUnhandledRejection=!0,this._fulfilledCallbacks=[],this._rejectedCallbacks=[],this._progressCallbacks=[],e){var n=this,i=e.length;try{e(function(e){n.isResolved()||n._resolve(e)},i>1?function(e){n.isResolved()||n._reject(e)}:t,i>2?function(e){n.isResolved()||n._notify(e)}:t)}catch(e){this._reject(e)}}};g.prototype={valueOf:function(){return this._value},isResolved:function(){return this._status!==f.PENDING},isFulfilled:function(){return this._status===f.FULFILLED},isRejected:function(){return this._status===f.REJECTED},then:function(e,t,n,i){this._shouldEmitUnhandledRejection=!1;var r=new h;return this._addCallbacks(r,e,t,n,i),r.promise()},catch:function(e,n){return this.then(t,e,n)},fail:function(e,n){return this.then(t,e,n)},always:function(e,t){var n=this,i=function(){return e.call(this,n)};return this.then(i,i,t)},progress:function(e,n){return this.then(t,t,e,n)},spread:function(e,t,n){return this.then(function(t){return e.apply(this,t)},t,n)},done:function(e,t,n,r){this.then(e,t,n,r).fail(i)},delay:function(e){var t,n=this.then(function(n){var i=new h;return t=setTimeout(function(){i.resolve(n)},e),i.promise()});return n.always(function(){clearTimeout(t)}),n},timeout:function(e){var t=new h,n=setTimeout(function(){t.reject(new v.TimedOutError("timed out"))},e);return this.then(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise().always(function(){clearTimeout(n)}),t.promise()},_vow:!0,_resolve:function(e){if(!(this._status>f.RESOLVED)){if(e===this)return void this._reject(TypeError("Can't resolve promise with itself"));if(this._status=f.RESOLVED,e&&e._vow)return void(e.isFulfilled()?this._fulfill(e.valueOf()):e.isRejected()?(e._shouldEmitUnhandledRejection=!1,this._reject(e.valueOf())):e.then(this._fulfill,this._reject,this._notify,this));if(s(e)||r(e)){var t;try{t=e.then}catch(e){return void this._reject(e)}if(r(t)){var n=this,i=!1;try{t.call(e,function(e){i||(i=!0,n._resolve(e))},function(e){i||(i=!0,n._reject(e))},function(e){n._notify(e)})}catch(e){i||this._reject(e)}return}}this._fulfill(e)}},_fulfill:function(e){this._status>f.RESOLVED||(this._status=f.FULFILLED,this._value=e,this._callCallbacks(this._fulfilledCallbacks,e),this._fulfilledCallbacks=this._rejectedCallbacks=this._progressCallbacks=t)},_reject:function(e){if(!(this._status>f.RESOLVED)){if(this._status=f.REJECTED,this._value=e,this._callCallbacks(this._rejectedCallbacks,e),!this._rejectedCallbacks.length){var i=this;n(function(){i._shouldEmitUnhandledRejection&&d(e,i)})}this._fulfilledCallbacks=this._rejectedCallbacks=this._progressCallbacks=t}},_notify:function(e){this._callCallbacks(this._progressCallbacks,e)},_addCallbacks:function(e,n,i,s,o){i&&!r(i)?(o=i,i=t):s&&!r(s)&&(o=s,s=t),i&&(this._shouldEmitUnhandledRejection=!1);var a;this.isRejected()||(a={defer:e,fn:r(n)?n:t,ctx:o},this.isFulfilled()?this._callCallbacks([a],this._value):this._fulfilledCallbacks.push(a)),this.isFulfilled()||(a={defer:e,fn:i,ctx:o},this.isRejected()?this._callCallbacks([a],this._value):this._rejectedCallbacks.push(a)),this._status<=f.RESOLVED&&this._progressCallbacks.push({defer:e,fn:s,ctx:o})},_callCallbacks:function(e,t){var i=e.length;if(i){var r=(this.isResolved(),this.isFulfilled()),s=this.isRejected();n(function(){for(var n,o,a,u=0;u<i;)if(n=e[u++],o=n.defer,a=n.fn,a){var c,l=n.ctx;try{c=l?a.call(l,t):a(t)}catch(e){o.reject(e);continue}r||s?o.resolve(c):o.notify(c)}else r?o.resolve(t):s?o.reject(t):o.notify(t)})}}};var p={cast:function(e){return v.cast(e)},all:function(e){return v.all(e)},race:function(e){return v.anyResolved(e)},resolve:function(e){return v.resolve(e)},reject:function(e){return v.reject(e)}};for(var m in p)p.hasOwnProperty(m)&&(g[m]=p[m]);var v={Deferred:h,Promise:g,defer:function(){return new h},when:function(e,t,n,i,r){return v.cast(e).then(t,n,i,r)},fail:function(e,n,i){return v.when(e,t,n,i)},always:function(e,t,n){return v.when(e).always(t,n)},progress:function(e,t,n){return v.when(e).progress(t,n)},spread:function(e,t,n,i){return v.when(e).spread(t,n,i)},done:function(e,t,n,i,r){v.when(e).done(t,n,i,r)},isPromise:function(e){return s(e)&&r(e.then)},cast:function(e){return e&&e._vow?e:v.resolve(e)},valueOf:function(e){return e&&r(e.valueOf)?e.valueOf():e},isFulfilled:function(e){return!e||!r(e.isFulfilled)||e.isFulfilled()},isRejected:function(e){return!(!e||!r(e.isRejected))&&e.isRejected()},isResolved:function(e){return!e||!r(e.isResolved)||e.isResolved()},resolve:function(e){var t=v.defer();return t.resolve(e),t.promise()},fulfill:function(e){var t=v.defer(),n=t.promise();return t.resolve(e),n.isFulfilled()?n:n.then(null,function(e){return e})},reject:function(e){var t=v.defer();return t.reject(e),t.promise()},invoke:function(t,n){var i,r=Math.max(arguments.length-1,0);if(r){i=Array(r);for(var s=0;s<r;)i[s++]=arguments[s]}try{return v.resolve(i?t.apply(e,i):t.call(e))}catch(e){return v.reject(e)}},all:function(e){var t=new h,n=a(e),i=n?u(e):c(e),r=i.length,s=n?[]:{};if(!r)return t.resolve(s),t.promise();var o=r;return v._forEach(e,function(e,n){s[i[n]]=e,--o||t.resolve(s)},t.reject,t.notify,t,i),t.promise()},allResolved:function(e){var t=new h,n=a(e),i=n?u(e):c(e),r=i.length,s=n?[]:{};if(!r)return t.resolve(s),t.promise();var o=function(){--r||t.resolve(e)};return v._forEach(e,o,o,t.notify,t,i),t.promise()},allPatiently:function(e){return v.allResolved(e).then(function(){var t,n,i,r,s=a(e),o=s?u(e):c(e),l=o.length,d=0;if(!l)return s?[]:{};for(;d<l;)i=o[d++],r=e[i],v.isRejected(r)?(t||(t=s?[]:{}),s?t.push(r.valueOf()):t[i]=r.valueOf()):t||((n||(n=s?[]:{}))[i]=v.valueOf(r));if(t)throw t;return n})},any:function(e){var t=new h,n=e.length;if(!n)return t.reject(Error()),t.promise();var i,r=0;return v._forEach(e,t.resolve,function(e){r||(i=e),++r===n&&t.reject(i)},t.notify,t),t.promise()},anyResolved:function(e){var t=new h;return e.length?(v._forEach(e,t.resolve,t.reject,t.notify,t),t.promise()):(t.reject(Error()),t.promise())},delay:function(e,t){return v.resolve(e).delay(t)},timeout:function(e,t){return v.resolve(e).timeout(t)},_forEach:function(e,t,n,i,r,s){for(var o=s?s.length:e.length,a=0;a<o;)v.when(e[s?s[a]:a],l(t,a),n,i,r),++a},TimedOutError:function(e){var t=function(t){this.name=e,this.message=t};return t.prototype=new Error,t}("TimedOut")},_=!0;"object"==typeof module&&"object"==typeof module.exports&&(module.exports=v,_=!1),"object"==typeof modules&&r(modules.define)&&(modules.define("vow",function(e){e(v)}),_=!1),"function"==typeof define&&(define("vow",["require","exports","module"],function(e,t,n){n.exports=v}),_=!1),_&&(e.vow=v)}("undefined"!=typeof window?window:global),define("utils/events-emitter",["jquery"],function(e){return{_getEventsEmitter:function(){return this._jqEventsEmitter||(this._jqEventsEmitter=e(this))},_bindHandler:function(e,t){var n=e.bind(t);return(this._handlersToUnbind||(this._handlersToUnbind=[])).push({handler:e,ctx:t,boundHandler:n}),n},trigger:function(e,t){return this._getEventsEmitter().trigger(e,t),this},once:function(e,t,n){return this._getEventsEmitter().one(e,n?this._bindHandler(t,n):t),this},on:function(e,t,n){return"object"==typeof e?Object.keys(e).forEach(function(n){this.on(n,e[n],t)},this):this._getEventsEmitter().bind(e,n?this._bindHandler(t,n):t),this},un:function(e,t,n){var i=n&&(this._handlersToUnbind||[]).find(function(e){return e.handler==t&&e.ctx==n});this._getEventsEmitter().unbind(e,n?i.boundHandler:t),i&&this._handlersToUnbind.splice(this._handlersToUnbind.indexOf(i),1)}}}),define("utils/extend",[],function(){var e=function(e){return e.call.bind(e)}(Object.prototype.hasOwnProperty);return function(t){"object"!=typeof t&&(t={});for(var n=1,i=arguments.length;n<i;n++){var r=arguments[n];if(r)for(var s in r)e(r,s)&&(t[s]=r[s])}return t}}),define("worker/client",["jquery","vow","ymaps","utils/events-emitter","utils/extend"],function(e,t,n,i,r){var s=e('script[data-main="js/app"]')[0].src,o=/app\.min\.js/.test(s)?s.replace(/app\.min\.js/,"worker.min.js"):"./js/worker.js",a=function(e,t){var n=this._worker=new Worker(o);n.addEventListener("message",this._onWorkerMessage.bind(this)),this._dataManager=e,this._stateManager=t,this._isInited=!1,this._isBusy=!0,this._messageQueue=[],this._commandsCount=0,this._cumulativeCommandsCount=0};return r(a.prototype,i),r(a.prototype,{_postInitMessage:function(){var e=this._worker,n=this._dataManager,i=this._stateManager;t.all({segments:n.getSegments(),routes:n.getRoutes(),freqs:n.getFreqs(),trolleyWires:n.getWiredSegments(),registry:n.getRegistry()}).done(function(t){e.postMessage({command:"init",params:r(t,{state:i.serialize()})})})},_onWorkerMessage:function(e){e.data.progress&&e.data.progress!==this._progress&&(this._progress=e.data.progress,this.trigger("progress",this._progress)),"instantiated"==e.data.state?this._postInitMessage():"busy"==e.data.state?this._isBusy=!0:"ready"==e.data.state?(this._isBusy=!1,this._isInited=!0,"key"in e.data?this.trigger("updated"):this.trigger("inited"),this._messageQueue.forEach(function(e){this.postMessage.apply(this,e)},this),this._messageQueue=[],this.trigger("message",e.data)):this.trigger("message",e.data)},postMessage:function(){this._isBusy?this._messageQueue.push(arguments):this._worker.postMessage.apply(this._worker,arguments)},command:function(e,n){var i=this,r=Math.random()+""+ +new Date,s=t.defer(),o=function(e,t){t.key==r&&(i._commandsCount>0&&i._commandsCount--,0==i._commandsCount&&(i._cumulativeCommandsCount=0),i._actualizeProgress(),this.un("message",o),s.resolve(t.result))};return this._commandsCount++,this._cumulativeCommandsCount++,this._actualizeProgress(),this.on("message",o),this.postMessage({command:e,params:n,key:r}),s.promise()},_actualizeProgress:function(){this._cumulativeCommandsCount?this.trigger("progress",(this._cumulativeCommandsCount-this._commandsCount)/this._cumulativeCommandsCount):this.trigger("ready")}}),a}),define("state/manager",["utils/extend","vow","utils/events-emitter"],function(e,t,n){var i=function(){var e,t=location.search.substr(1).split("&").reduce(function(e,t){var n=t.split("=");return e[decodeURIComponent(n[0])]=decodeURIComponent(n[1])||"",e},{});try{e=JSON.parse(localStorage.getItem("bounds"))}catch(e){}this._bounds=e&&e[0]&&e[0][0]?e:[[55.74,37.55],[55.76,37.65]],this._timeSettings={dow:{6:32,0:64}[(new Date).getDay()]||1,fromHour:7,toHour:24,date:+new Date((new Date).toISOString().substring(0,10))},this._widthFactor=1,this._isEqualWidthsMode="equal"in t,this._isDebugMode="debug"in t,this._white=t.white||.7,this._customColoringId=t.coloring||"default",this._isTouch=!0,this._isNarrow=window.innerWidth<500};return e(i.prototype,n),e(i.prototype,{getBounds:function(){return this._bounds},setBounds:function(e){JSON.stringify(e)!=JSON.stringify(this._bounds)&&(this._bounds=e,localStorage.setItem("bounds",JSON.stringify(e)),this.trigger("bounds-updated",e))},getTimeSettings:function(){return this._timeSettings},setTimeSettings:function(e){var t=!1;Object.keys(e).forEach(function(n){this._timeSettings[n]!=e[n]&&(this._timeSettings[n]=e[n],t=!0)},this),t&&this.trigger("time-settings-updated",this._timeSettings)},setState:function(e){var t=!1;"timeSettings"in e&&Object.keys(e.timeSettings).forEach(function(n){this._timeSettings[n]!=e.timeSettings[n]&&(this._timeSettings[n]=e.timeSettings[n],t=!0)},this),"customColoringId"in e&&(this._customColoringId=e.customColoringId,t=!0),"widthFactor"in e&&(this._widthFactor=e.widthFactor,t=!0),"isEqualWidthsMode"in e&&(this._isEqualWidthsMode=e.isEqualWidthsMode,t=!0),t&&this.trigger("state-updated")},getWhite:function(){return this._white},getWidthFactor:function(){return this._widthFactor},setWidthFactor:function(e){this._widthFactor!=e&&(this._widthFactor=e,this.trigger("width-factor-updated",e))},isEqualWidthsMode:function(){return this._isEqualWidthsMode},isAdminMode:function(){return!1},isDebugMode:function(){return this._isDebugMode},isMobile:function(){return this._isTouch&&this._isNarrow},setCustomColoringId:function(e){
this._customColoringId=e,this.trigger("coloring-id-updated",e)},getCustomColoringId:function(){return this._customColoringId},serialize:function(){return{timeSettings:this._timeSettings,selectedRoutes:[],widthFactor:this._widthFactor,isEqualWidthsMode:this._isEqualWidthsMode,isAdminMode:this._isAdminMode,isDebugMode:this._isDebugMode,white:this._white,customColoringId:this._customColoringId,isTouch:this._isTouch,isNarrow:this._isNarrow}}}),i}),define("utils/geom",[],function(){function e(e,t){if(e>=i||e<=0)return{points:t.points.reverse(),segLengths:t.segLengths.reverse()};for(var n=0,i=0;i<e;)i+=t.segLengths[n],n++;var r=1-(i-e)/t.segLengths[n-1],s=t.points[n-1],o=t.points[n];return s&&o?{points:[[s[0]+r*(o[0]-s[0]),s[1]+r*(o[1]-s[1])]].concat(t.points.slice(n)).reverse(),segLengths:[(1-r)*t.segLengths[n-1]].concat(t.segLengths.slice(n)).reverse()}:(console.warn(e,t,n),{points:t.points.reverse(),segLengths:t.segLengths.reverse()})}function t(e,t){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}function n(e){return e.slice(1).map(function(n,i){return t(n,e[i])})}function r(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]);return t?[e[0]/t,e[1]/t]:[0,0]}return{getLength:function(e){return n(e).reduce(function(e,t){return e+t},0)},cut:function(t,i,r){if(i+r==0)return t;var s=n(t),o=s.reduce(function(e,t){return e+t},0);if(i+r==0||0==o)return t;if(i+r>o-1){var a=(o-1)/(i+r);i*=a,r*=a}return e(r,e(i,{points:t,segLengths:s})).points},bounds:function(e){return e.reduce(function(e,t){return(t[0]<e[0][0]||!e[0][0])&&(e[0][0]=t[0]),(t[1]<e[0][1]||!e[0][1])&&(e[0][1]=t[1]),(t[0]>e[1][0]||!e[1][0])&&(e[1][0]=t[0]),(t[1]>e[1][1]||!e[1][1])&&(e[1][1]=t[1]),e},[[],[]])},findIntersectionPos:function(e,t){var n=e[0],i=t[0],r=[e[1][0]-e[0][0],e[1][1]-e[0][1]],s=[t[1][0]-t[0][0],t[1][1]-t[0][1]];return((n[1]-i[1])*s[0]-(n[0]-i[0])*s[1])/(r[0]*s[1]-r[1]*s[0])},roundAngle:function(e,n,r,s){var o=[(n[0]-e[0])/t(e,n),(n[1]-e[1])/t(e,n)],a=[(r[0]-n[0])/t(n,r),(r[1]-n[1])/t(n,r)],u=[a[0]*o[0]+a[1]*o[1],-a[0]*o[1]+a[1]*o[0]],c=u[1],l=u[0],d=Math.sign(c),h=d*Math.acos(l),f=Math.sqrt((1-l)/2),g=Math.sqrt((1+l)/2),p=Math.min(t(e,n),t(n,r),s*f/g);s=p*g/f;var m=[d*o[1]*s,-d*o[0]*s],v=[n[0]-o[0]*p,n[1]-o[1]*p],_=[v[0]-m[0],v[1]-m[1]],y=Math.abs(Math.round(2*Math.PI*h/1)),b=h/y;if(y<1)return[e,n,r];var w=[n[0]+a[0]*p,n[1]+a[1]*p],x=Math.sin(b),R=Math.cos(b),S=[e];for(t(v,e)>1e-5&&S.push(v),i=1;i<y-1;i++)m=[m[0]*R-m[1]*x,m[0]*x+m[1]*R],S.push([_[0]+m[0],_[1]+m[1]]);return t(w,r)>1e-5&&S.push(w),S.push(r),S},deduplicate:function(e){return e.filter(function(e,t,n){return e!==n[t-1]})},offsetLine:function(e,t){var n=[],s=e.length-1,o=[],a=[];for(i=0;i<s;i++)if(o[i]=r([e[i+1][0]-e[i][0],e[i+1][1]-e[i][1]]),i>0){var u=r([o[i-1][0]+o[i][0],o[i-1][1]+o[i][1]]);a[i]=[-u[1],u[0]]}for(n.push([e[0][0]-o[0][1]*t,e[0][1]+o[0][0]*t]),i=1;i<s;i++){var c=o[i][0]*a[i][1]-o[i][1]*a[i][0],l=t*Math.min(1/c,3);n.push([e[i][0]+a[i][0]*l,e[i][1]+a[i][1]*l])}return n.push([e[s][0]-o[s-1][1]*t,e[s][1]+o[s-1][0]*t]),n}}}),define("utils/date",{findNearestDate:function(e,t,n){var i=e.sort(function(e,t){return+new Date(e)-+new Date(t)}).filter(function(e){return n?+new Date(e)<t:+new Date(e)<=t});return i[i.length-1]}}),define("data/trolley",[],function(){var e={isSegmentInRoute:function(e,t,n){var i=n[e];return i&&(-1!=i.indexOf(">"+t)||-1!=i.indexOf("<"+t)||-1!=i.indexOf(t))},isSegmentTrolleyForRoute:function(e,t,n,i){e=+e;var r=n[e],s=r&&-1!=r.indexOf(">"+t),o=r&&-1!=r.indexOf("<"+t),a=r&&-1!=r.indexOf(t),u=-1!=i.forward.indexOf(e),c=-1!=i.backward.indexOf(e),l=-1!=i.both.indexOf(e);return s&&o&&(a=!0),a&&(s=!1,o=!1),s&&(u||l)||o&&(c||l)||a&&l},getTrolleyFraction:function(t,n,i,r){var s=0,o=0;return Object.keys(n).forEach(function(a){if(e.isSegmentInRoute(a,t,i)){var u=i[a].reduce(function(e,n){return n==t?e+2:n==">"+t||n=="<"+t?e+1:e},0);s+=u*n[a],e.isSegmentTrolleyForRoute(a,t,i,r)&&(o+=u*n[a])}}),o/s}};return e}),define("data/actuals/routes",["vow","utils/date"],function(e,t){return{shouldRecalc:function(e,t){return-1!=t.indexOf("timeSettings")},calc:function(n,i){return e.resolve(Object.keys(n.routes).reduce(function(e,r){var s=n.routes[r]||[];return e[r]=s[t.findNearestDate(Object.keys(s),i.timeSettings.date)]||[],e},{}))}}}),define("utils/route",[],function(){var e={strip:function(e){return e.replace(/^[-<>]/,"")},getType:function(t){return t=e.strip(t),t.indexOf("Тб")?t.indexOf("Тм")?"bus":"tram":"trolley"},clearType:function(t){return e.strip(t).replace(/^(Тб|Тм) /,"")},notPhantom:function(e){return"-"!=e[0]},inverse:function(e){return e.replace(/^</,"%").replace(/^>/,"<").replace(/^%/,">")},inverseList:function(t,n){return n||(n=-1),n<0?t.map(e.inverse).reverse():t}};return e}),define("data/actuals/existing-routes",["vow","utils/route"],function(e,t){return{shouldRecalc:function(e,t){return-1!=t.indexOf("timeSettings")},deps:["routes"],calc:function(n,i,r){return e.resolve(Object.keys(Object.keys(r).reduce(function(e,n){return r[n].forEach(function(n){e[t.strip(n)]=!0}),e},{})))}}}),define("data/actuals/widths",["vow"],function(e){return{shouldRecalc:function(e,t){return!0},deps:["existingRoutes"],calc:function(t,n,r){return e.resolve(r.reduce(function(e,r){var s=t.freqs[r]||{};return currentDay=Object.keys(s).filter(function(e){return e&n.timeSettings.dow}),tt=s[currentDay]||{},i=0,n.isEqualWidthsMode?e[r]=2:1==n.selectedRoutes.length?e[r]=r==n.selectedRoutes[0]?20:0:(e[r]=Object.keys(tt).reduce(function(e,t){return t>=n.timeSettings.fromHour&&t<=n.timeSettings.toHour&&(e+=tt[t],i++),e},0)/i,n.selectedRoutes.length&&-1==n.selectedRoutes.indexOf(r)&&(e[r]=0)),e[r]*=n.widthFactor,e[r]=Math.round(100*e[r])/100||e[r],e},{}))}}}),define("utils/bus-color",[],function(){function e(e){var t=e[0]-Math.floor(e[0]),n=e[1],i=e[2];if(!n)return[i,i,i];t*=6;var r=Math.floor(t),s=[1-n,1-n*(t-r),1-n*(1-(t-r)),1];return[[3,2,0],[1,3,0],[0,3,2],[0,1,3],[2,0,3],[3,0,1]][r].map(function(e){return i*s[e]})}function t(e){return r=256*e[0]|0,g=256*e[1]|0,b=256*e[2]|0,"#"+("0"+r.toString(16)).substr(-2)+("0"+g.toString(16)).substr(-2)+("0"+b.toString(16)).substr(-2)}function n(e,t,n){var i=t+e*(n-t);return i-Math.floor(i)}function i(i){i+="";var r=2,s=!1;-1!=i.indexOf("Тб")&&(i=i.substr(3),r=1),-1!=i.indexOf("Тм")&&(i=i.substr(3),r=0),-1!=i.indexOf("э")&&(i=i.replace(/э/g,""),r=3),/.?[a-я]$/.test(i)&&(i=i.substr(0,i.length-1),s=!0),i=+i.replace(/^[^\d]/g,""),isNaN(i)&&(i=0);var o=[(i+2)%11/10,.09+i/16%4*.2,.48+i%5*.09];switch(r){case 0:o[0]=n(o[0],-.1,.05),o[1]=n(o[1],.75,1),o[2]=n(o[2],1-3*(o[1]-.75),1);break;case 1:o[0]=n(o[0],.2,.4),o[1]=n(o[1],.7+.3*Math.abs(o[0]-.3),1),o[2]=n(o[2],.3,1);break;case 2:o[0]=n(o[0],.4+o[1]/4,1-o[1]/4),o[1]=n(o[1],0,1-.5*Math.abs(o[0]-.8)),o[2]=n(o[2],0,1-.3*Math.abs(o[0]-.8));break;case 3:o[0]=n(o[0],.1,.14),o[1]=n(o[1],.9,1),o[2]=n(o[2],1-2*(o[1]-.75),1)}return s&&(o[1]=n(o[1],0,.9),o[2]=n(o[2],.3,1)),t(e(o))}return i});var PROJECT_ROUTES=["Т79","Т3","Т47","Т10","Б","Т39","Т67","Т40","Т71","Т72","Т52","м9","24к","м1","648","64","223","205к","247","164","237","24","763к","209","232","651","271","Т15","633","298","709","683","Т25","215к","85","132","291","263","м6","791","832","834","241","789","615","221","м3","275","706к","811","м2","608","155","805","659","230","690","31","А","39","761","216","255","645","51","299","806","776","803","742","152","194","С5","276","706","116","С8","700","52","171","159","84к","257","12","39к","67","57","672","84","130","143","800","763","40","96","9","м10","656","709к","179","623","142","101","730","8","186","820","153","701","278","147","106","220","38","214","В"];define("data/colorings/default",["utils/bus-color"],function(e){return{getRouteColor:function(t,n,i){var r=n.registry&&n.registry[t]&&n.registry[t].express;return e(t+(r?"э":""))},getSegmentOutlines:function(e,t,n){return null},getRouteOutlines:function(e,t,n,i){return null},shouldRecalcColorsOn:["timeSettings"],shouldRecalcOutlinesOn:[]}}),define("data/colorings/type",[],function(){return{getRouteColor:function(e,t,n){return-1!=e.indexOf("Тм")?"#e44":-1!=e.indexOf("Тб")?"#7c3":"#47c"},getSegmentOutlines:function(e,t,n){return null},getRouteOutlines:function(e,t,n,i){return null},shouldRecalcColorsOn:["timeSettings"],shouldRecalcOutlinesOn:[]}}),define("data/colorings/black",[],function(){return{getRouteColor:function(e,t,n){return"#000"},getSegmentOutlines:function(e,t,n){return null},getRouteOutlines:function(e,t,n,i){return null},shouldRecalcColorsOn:["timeSettings"],shouldRecalcOutlinesOn:[]}}),define("data/colorings/vendor",[],function(){return{getRouteColor:function(e,t,n){return t.registry&&t.registry[e]&&{autoline:"#59c",tmp20:"#871",alphagrant:"#d22",rico:"#1bf",gepart:"#528",gortaxi:"#ff2",autocars:"#000",transway:"#f0f"}[t.registry[e].vendor]||"#ddd"},getSegmentOutlines:function(e,t,n){return null},getRouteOutlines:function(e,t,n,i){return null},shouldRecalcColorsOn:["timeSettings"],shouldRecalcOutlinesOn:[]}}),define("data/colorings/troll-project",["data/trolley"],function(e){return{getRouteColor:function(t,n,i,r){var s=e.getTrolleyFraction(t,r.lengths,r.actualRoutes,n.trolleyWires),o=0,a=0;return Object.keys(r.lengths).forEach(function(i){if(e.isSegmentInRoute(i,t,r.actualRoutes)){var s=r.actualRoutes[i].reduce(function(e,n){return n==t?e+2:n==">"+t||n=="<"+t?e+1:e},0);o+=s*r.lengths[i],e.isSegmentTrolleyForRoute(i,t,r.actualRoutes,n.trolleyWires)&&(a+=s*r.lengths[i])}}),-1!=t.indexOf("Тм")?"#f84":-1!=t.indexOf("Тб")?"#4d2":"rgb("+Math.round(34*s)+","+Math.round(187*s)+","+Math.round(255*s)+")"},getRouteOutlines:function(t,n,i,r,s){return e.isSegmentTrolleyForRoute(t,n,s.actualRoutes,i.trolleyWires)?"#af5":"#999"},getSegmentOutlines:function(t,n,i,r){if(1==i.selectedRoutes.length){var s=i.selectedRoutes[0];return e.isSegmentInRoute(t,s,r.actualRoutes)?e.isSegmentTrolleyForRoute(t,s,r.actualRoutes,n.trolleyWires)?{10:{color:"#af5",avoidEmpty:!0}}:{10:{color:"#999",avoidEmpty:!0}}:null}},shouldRecalcColorsOn:["timeSettings"],shouldRecalcOutlinesOn:["timeSettings","selectedRoutes"]}}),define("data/colorings/wires",[],function(){return{getRouteColor:function(e,t,n,i){return-1!=e.indexOf("Тм")?"#f84":-1!=e.indexOf("Тб")?"#1bf":"#528"},getSegmentOutlines:function(e,t,n,i){return-1!=t.trolleyWires.both.indexOf(e)?{10:"#6f0"}:-1!=t.trolleyWires.forward.indexOf(e)?{5:{color:"#6f0",offset:5}}:-1!=t.trolleyWires.backward.indexOf(e)?{5:{color:"#6f0",offset:-5}}:null},getRouteOutlines:function(e,t,n,i){return null},shouldRecalcColorsOn:["timeSettings"],shouldRecalcOutlinesOn:["timeSettings"]}}),define("data/actuals/colors",["vow","data/colorings/default","data/colorings/type","data/colorings/black","data/colorings/vendor","data/colorings/troll-project","data/colorings/wires"],function(e,t,n,i,r,s,o){var a={default:t,type:n,black:i,vendor:r,"troll-project":s,wires:o};return{shouldRecalc:function(e,t){var n=a[e.customColoringId||"default"];return-1!=t.indexOf("customColoringId")||n.shouldRecalcColorsOn.some(function(e){return-1!=t.indexOf(e)})},deps:["widths","routes","existingRoutes","lengths"],calc:function(t,n,i,r,s,o){var u=a[n.customColoringId||"default"];return e.resolve(s.reduce(function(e,s){return e[s]=u.getRouteColor(s,t,n,{actualWidths:i,actualRoutes:r,lengths:o}),e},{}))}}}),define("data/actuals/outlines",["vow","data/colorings/default","data/colorings/type","data/colorings/black","data/colorings/vendor","data/colorings/troll-project","data/colorings/wires"],function(e,t,n,i,r,s,o){var a={default:t,type:n,black:i,vendor:r,"troll-project":s,wires:o};return{shouldRecalc:function(e,t){var n=a[e.customColoringId||"default"];return-1!=t.indexOf("customColoringId")||n.shouldRecalcOutlinesOn.some(function(e){return-1!=t.indexOf(e)})},deps:["widths","routes"],calc:function(t,n,i,r){var s=a[n.customColoringId||"default"];return e.resolve(Object.keys(t.segments).reduce(function(e,o){return e[+o]=s.getSegmentOutlines(+o,t,n,{actualWidths:i,actualRoutes:r}),e},{}))}}}),define("data/actuals/route-outlines",["vow","utils/route","data/colorings/default","data/colorings/type","data/colorings/black","data/colorings/vendor","data/colorings/troll-project","data/colorings/wires"],function(e,t,n,i,r,s,o,a){var u={default:n,type:i,black:r,vendor:s,"troll-project":o,wires:a};return{shouldRecalc:function(e,t){var n=u[e.customColoringId||"default"];return-1!=t.indexOf("customColoringId")||n.shouldRecalcOutlinesOn.some(function(e){return-1!=t.indexOf(e)})},deps:["widths","routes"],calc:function(n,i,r,s){var o=u[i.customColoringId||"default"];return e.resolve(Object.keys(n.segments).reduce(function(e,a){var u=(s[a]||[]).reduce(function(e,u){var c=t.strip(u);return e[c]=o.getRouteOutlines(+a,c,n,i,{actualWidths:r,actualRoutes:s}),e},{}),c=Object.keys(u)[0],l=Object.keys(u).some(function(e){return u[e]!=u[c]});return e[+a]=l?u:u[c]||null,e},{}))}}}),define("data/actuals/max-width",["vow","utils/route"],function(e,t){return{shouldRecalc:function(e,t){return!0},deps:["widths","routes"],calc:function(n,i,r,s){return e.resolve(n.segments.reduce(function(e,n,i){if(n.length){var o=(s[i]||[]).reduce(function(e,n){return e+(r[t.strip(n)]||0)},0);return Math.max(o,e)}},0))}}}),define("utils/junction",["utils/geom","utils/route"],function(e,t){counter=0;var n={getEndPointKey:function(e){return Math.round(2e3*e[0])+"_"+Math.round(1e3*e[1])},getEndPointByKey:function(e){return[e.split("_")[0]/2e3,e.split("_")[1]/1e3]},getRoutePassingModes:function(e,n){var i={},r=e.reduce(function(e,i){var r=(n[Math.abs(i)]||[]).filter(t.notPhantom);return i<0&&(r=r.map(function(e,t){return e.replace(">","%").replace("<",">").replace("%","<")}).reverse()),e[i]=r,e},{}),s=function(t,n){return e.filter(function(e){return e!==n&&1==r[e].filter(function(e){return e===t}).length})};return e.forEach(function(e){var n=r[e].map(function(e,t){return e.replace(">","%").replace("<",">").replace("%","<")}).reverse();n.forEach(function(r){var o=t.strip(r);if(!i[o])if(0==r.indexOf("<")||0==r.indexOf(">"))if(n.filter(function(e){return t.strip(e)==o}).length>1)i[o]={type:"strange"};else{var a=s(r,e),u=s((">"==r[0]?"<":">")+o,e),c=s(o,e);if(u.length>0)i[o]={type:"strange"};else if(1==a.length&&1==c.length){var l={};l[c[0]]=[{to:e,as:(">"==r[0]?"<":">")+o},{to:a[0],as:r}],l[e]=[{to:c[0],as:o}],l[a[0]]=[{to:c[0],as:o}],i[o]={type:"splitting",ways:l}}else if(1==a.length&&0==c.length){var l={};l[e]=[{to:a[0],as:r}],l[a[0]]=[{to:e,as:(">"==r[0]?"<":">")+o}],i[o]={type:"passing",ways:l}}else i[o]={type:"strange"}}else if(n.filter(function(e){return e==">"+o||e=="<"+o}).length>0)i[o]={type:"strange"};else if(1==n.filter(function(e){return e==o}).length){var d=s(">"+o,e),h=s("<"+o,e),c=s(o,e);if(0==d.length&&0==h.length&&0==c.length)i[o]={type:"ending"};else if(0==d.length&&0==h.length&&1==c.length)l={},l[e]=[{to:c[0],as:o}],l[c[0]]=[{to:e,as:o}],i[o]={type:"passing",ways:l};else if(0==d.length&&0==h.length&&2==c.length){var l={};l[c[0]]=[{to:c[1],as:o},{to:e,as:o}],l[c[1]]=[{to:c[0],as:o},{to:e,as:o}],l[e]=[{to:c[0],as:o},{to:c[1],as:o}],i[o]={type:"3-way",ways:l}}else if(1==d.length&&1==h.length&&d[0]!=h[0]&&0==c.length){var l={};l[e]=[{to:h[0],as:"<"+o},{to:d[0],as:">"+o}],l[h[0]]=[{to:e,as:"<"+o}],l[h[0]]=[{to:e,as:">"+o}],i[o]={type:"splitting",ways:l}}else i[o]={type:"strange"}}else if(n.filter(function(e){return e==o}).length=2)if(0==s(o,e).length&&0==s(">"+o,e).length&&0==s("<"+o,e).length){var l={};l[e]=[{to:e,as:o}],i[o]={type:"u-turn",ways:l}}else i[o]={type:"strange"};else i[o]={type:"strange"}})}),i},extractJunctionRouteGroups:function(e,i,r){function s(e,n,i){var r=u[t.strip(i)],s=r&&r.ways&&r.ways[e]&&r.ways[e].filter(function(e){return e.to===n})[0];return!!s&&s.as}function o(e){return e.reduce(function(e,n){return e+(r[t.strip(n)]||0)},0)}var a=[],u=n.getRoutePassingModes(e,i),c=Object.keys(u).filter(function(e){return"ending"==u[e].type||"u-turn"==u[e].type||"strange"==u[e].type});return e.forEach(function(n,r){var u=t.inverseList(i[Math.abs(n)]||[],-n),c=o(u);e.slice(r+1).forEach(function(e){for(var r=t.inverseList(i[Math.abs(e)]||[],e),l=o(r),d=0,h=0,f=null,g=0,p=0;d<u.length;){if(f){if(t.notPhantom(u[d])&&r[h]==s(n,e,u[d])){var m=r[h].length>u[d].length?r[h]:u[d];f.push(m),d++,h++;continue}var v=o(f);a.push({from:n,to:e,routes:f,fromShift:g+v/2-c/2,toShift:p+v/2-l/2,groupWidth:v}),f=null}if(t.notPhantom(u[d]))if(s(n,e,u[d])){if(-1===(h=r.indexOf(s(n,e,u[d])))){console.warn("couldn't find",s(n,e,u[d]),"among",JSON.stringify(r)),d++;continue}f=[],g=o(u.slice(0,d)),p=o(r.slice(0,h))}else d++;else d++}if(f){var v=o(f);a.push({from:n,to:e,routes:f,fromShift:g+v/2-c/2,toShift:p+v/2-l/2,groupWidth:v})}})}),c.length&&e.forEach(function(e){for(var n=0,r=i[Math.abs(e)]||[],s=o(r),u=null,l=0;n<r.length;){if(u){if(t.notPhantom(r[n])&&-1!=c.indexOf(t.strip(r[n]))){u.push(t.strip(r[n])),n++;continue}var d=o(u);a.push({from:e,routes:u,fromShift:l+d/2-s/2,groupWidth:d}),u=null}t.notPhantom(r[n])?-1==c.indexOf(t.strip(r[n]))?n++:(u=[],l=o(r.slice(0,n))):n++}}),a.sort(function(e,t){return t.groupWidth-e.groupWidth}),a},getJunctionLineGeometry:function(t,n,i,r,s,o){var a=e.deduplicate(e.offsetLine(i,s)),u=e.deduplicate(e.offsetLine(r,o)),c=[a[a.length-2],a[a.length-1]],l=e.getLength(c),d=[u[0],u[1]],h=e.getLength(d),f=c[1],g=d[0],p=[f,[f[0]+(c[1][0]-c[0][0])/l,f[1]+(c[1][1]-c[0][1])/l]],m=[g,[g[0]-(d[1][0]-d[0][0])/h,g[1]-(d[1][1]-d[0][1])/h]],v=e.findIntersectionPos(p,m),_=e.findIntersectionPos(m,p);if(v>0&&_>0){var y=[f[0]+(p[1][0]-p[0][0])*v,f[1]+(p[1][1]-p[0][1])*v];return e.deduplicate(e.roundAngle(f,y,g,t))}var b=[-(c[1][1]-c[0][1])/l,(c[1][0]-c[0][0])/l],w=[-(d[1][1]-d[0][1])/h,(d[1][0]-d[0][0])/h],x=Math.max(e.findIntersectionPos(p,[n,[n[0]+b[0],n[1]+b[1]]]),t/10),R=Math.max(e.findIntersectionPos(m,[n,[n[0]+w[0],n[1]+w[1]]]),t/10),S=[f[0]+(p[1][0]-p[0][0])*x/3,f[1]+(p[1][1]-p[0][1])*x/3],O=[g[0]+(m[1][0]-m[0][0])*R/3,g[1]+(m[1][1]-m[0][1])*R/3],E=[(S[0]+O[0])/2,(S[1]+O[1])/2];return e.deduplicate([].concat(e.roundAngle(f,S,E,t)).concat(e.roundAngle(E,O,g,t)))}};return n}),define("data/actuals/junctions",["vow","utils/junction","utils/route"],function(e,t,n){return{shouldRecalc:function(e,t){return!0},deps:["routes","widths"],calc:function(i,r,s,o){var a=i.segments,u=Object.keys(a).reduce(function(e,n){var i=a[n][0],r=a[n][a[n].length-1];return(e[t.getEndPointKey(i)]||(e[t.getEndPointKey(i)]=[])).push(n),(e[t.getEndPointKey(r)]||(e[t.getEndPointKey(r)]=[])).push(-n),e},{}),c=Object.keys(u).reduce(function(e,t){return e[t]=Math.min(Math.max(u[t].reduce(function(e,t){return Math.max(e,(s[Math.abs(t)]||[]).reduce(function(e,t){return e+(o[n.strip(t)]||0)},0))},0),10),100),e},{}),l=Object.keys(u).reduce(function(e,n){var i=t.extractJunctionRouteGroups(u[n],s,o);return i.length&&(e[n]=i),e},{});return e.resolve(Object.keys(l).reduce(function(e,t){return e[t]={size:c[t],routeGroups:l[t]},e},{}))}}}),define("data/actuals/route-bounds",["vow","utils/route","utils/geom"],function(e,t,n){return{shouldRecalc:function(e,t){return-1!=t.indexOf("timeSettings")},deps:["routes"],calc:function(i,r,s){return e.resolve(i.segments.reduce(function(e,r,o){return(s[o]||[]).forEach(function(r){var s=n.bounds(i.segments[o]);routeBounds=e[t.strip(r)],routeBounds?e[t.strip(r)]=[[Math.min(s[0][0],routeBounds[0][0]),Math.min(s[0][1],routeBounds[0][1])],[Math.max(s[1][0],routeBounds[1][0]),Math.max(s[1][1],routeBounds[1][1])]]:e[t.strip(r)]=s}),e},{}))}}}),define("utils/wgs-84",[],function(){function e(e,t,n){return e-Math.floor((e-t)/(n-t))*(n-t)}function t(t){var n=Math.max(Math.min(t[1],90-a),-90+a)*s,o=r*Math.sin(n);return[i*e(t[0]*s,-Math.PI,Math.PI),i*Math.log(Math.tan(.25*Math.PI+.5*n)/Math.pow(Math.tan(.25*Math.PI+.5*Math.asin(o)),r))]}function n(e){var t=.5*Math.PI-2*Math.atan(1/Math.exp(e*h));return(t+f*Math.sin(2*t)+g*Math.sin(4*t)+p*Math.sin(6*t)+m*Math.sin(8*t))*o}var i=6378137,r=.0818191908426,s=Math.PI/180,o=180/Math.PI,a=1e-10,u=r*r,c=u*u,l=c*u,d=c*c,h=1/i,f=u/2+5*c/24+l/12+13*d/360,g=7*c/48+29*l/240+811*d/11520,p=7*l/120+81*d/1120,m=4279*d/161280,v=2*Math.PI*i,_=(Math.sqrt(1-u),1/v),y=v/2,b=0,w=256*_;return{fromGlobalPixels:function(t,i){return i!=b&&(w=Math.pow(2,i+8)*_,b=i),[e(Math.PI*t[0]/Math.pow(2,i+7)-Math.PI,-Math.PI,Math.PI)*o,n(y-t[1]/w)]},toGlobalPixels:function(e,n){n!=b&&(w=Math.pow(2,n+8)*_,b=n);var i=t(e);return[(y+i[0])*w,(y-i[1])*w]}}}),define("data/actuals/lengths",["vow","utils/geom","utils/wgs-84"],function(e,t,n){return{shouldRecalc:function(){return!1},deps:[],calc:function(i){return e.resolve(i.segments.reduce(function(e,i,r){return e[r]=Math.round(t.getLength(i.map(function(e){return n.toGlobalPixels(e,20)}))),e},{}))}}}),define("data/calc-actuals",["vow","utils/extend","utils/date","data/actuals/routes","data/actuals/existing-routes","data/actuals/widths","data/actuals/colors","data/actuals/outlines","data/actuals/route-outlines","data/actuals/max-width","data/actuals/junctions","data/actuals/route-bounds","data/actuals/lengths"],function(e,t,n,i,r,s,o,a,u,c,l,d,h){function f(e,t){var n,i,r=[];return Array.isArray(e)?(n=e,i=!1):(n=t[e].deps||[],i=e),n.forEach(function(e){r.push.apply(r,f(e,t))}),i&&r.push(i),r.filter(function(e,t){return-1===r.slice(0,t).indexOf(e)})}return function(n,g,p,m){var v=e.defer(),_={routes:i,existingRoutes:r,widths:s,colors:o,outlines:a,routeOutlines:u,maxWidth:c,junctions:l,routeBounds:d,lengths:h},y=Object.keys(_).filter(function(e){return!m[e]||_[e].shouldRecalc(g,p)}),b={};return y=f(y,_),y.forEach(function(t,i){b[t]=e.all((_[t].deps||[]).map(function(e){return-1!=y.indexOf(e)?b[e]:m[e]})).then(function(e){return _[t].calc.apply(_[t],[n,g].concat(e))}),v.notify((i+1)/y.length)}),e.all(b).then(function(e){v.notify(1),v.resolve(t(m,e))}),v.promise()}}),define("data/manager",["jquery","ymaps","utils/extend","vow","utils/geom","utils/date","data/trolley","utils/events-emitter","data/calc-actuals"],function(e,t,n,i,r,s,o,a,u){var c={mgt:"ГУП «Мосгортранс»","mgt-express":"ГУП «Мосгортранс»",autoline:"ООО «Трансавтолиз»",tmp20:"ООО «Таксомоторный парк №20»",alphagrant:"ООО «Альфа Грант»",rico:"ООО Транспортная компания «Рико»",gepart:"ООО «Гепарт»",gortaxi:"ООО «ГорТакси»",autocars:"ООО «Авто-Карз»",transway:"ООО «Транс-Вей»"},l=function(e){this._stateManager=e,this._data={},this._loadingPromises={},this._actuals={},this._actualsReady=!1,this._actualsDeferred=i.defer(),this._changedFiles={},this._saveWindows={},this._stateManager.on({"state-updated":this._dropActuals.bind(this)},this)};return n(l.prototype,a),n(l.prototype,{_getDataFromFile:function(t){if(t in this._data)return i.resolve(this._data[t]);if(t in this._loadingPromises)return i.resolve(this._loadingPromises[t]);var n=i.defer(),r=n.promise();return e.ajax({url:t,data:{},success:function(e){this._data[t]=e,n.resolve(e)},dataType:"json",error:function(e,i,r){alert("error on "+t+": "+r.message),n.reject(r)},context:this}),this._loadingPromises[t]=r,r},getSegments:function(){return this._getDataFromFile("data/segments.json")},setSegmentGeometry:function(e,t){return i.all([this.getSegments(),this.getSegmentBounds()]).done(function(){this._data["data/segments.json"][e]=t,this._bounds[e]=r.bounds(t),this._changedFiles["data/segments.json"]=!0,this.trigger("data-updated")},this)},getSegmentCount:function(){return this.getSegments().then(function(e){return e.length},this)},getRoutes:function(){return this._getDataFromFile("data/routes.json")},getLastDate:function(){return this.getRoutes().then(function(e){var t=Object.keys(Object.keys(e).reduce(function(t,n){return Object.keys(e[n]).forEach(function(e){t[e]=!0}),t},{})).sort();return t[t.length-1]})},getRoutesForSegment:function(e){return this._getDataFromFile("data/routes.json").then(function(t){return t[e]||{}})},setRoutesForSegment:function(e,t){return this.getRoutesForSegment(e).then(function(){this._data["data/routes.json"][e]=t,this._changedFiles["data/routes.json"]=!0,this.trigger("data-updated")},this)},getActualRoutesForSegment:function(e){return i.when(this._actualsDeferred.promise()).then(function(t){return t.routes[e]},this)},getFreqs:function(){return this._getDataFromFile("data/freqs.json")},getActualWidthForRoute:function(e){return i.when(this._actualsDeferred.promise()).then(function(t){return t.widths[e]},this)},getBusColor:function(e){return i.when(this._actualsDeferred.promise()).then(function(t){return t.colors[e]||"#ccc"},this)},getRegistry:function(){return this._getDataFromFile("data/rgam.json")},getWiredSegments:function(){return this._getDataFromFile("data/trolley-wire.json")},getSegmentLengths:function(){return this.getSegments().then(function(e){var n=t.projection.wgs84Mercator;return e.reduce(function(e,t,i){return t[0][0]?(e[i]=r.getLength(t.map(function(e){return n.toGlobalPixels(e,20)})),e):e},{})},this)},getRouteSummaryHtml:function(e){return i.all([this.getFreqs(),this.getRegistry(),this.getSegmentLengths(),this.getWiredSegments(),this._actualsDeferred.promise()]).spread(function(t,n,i,r){var s="",a=n[e],u=this._stateManager;if(a&&(s+='<span class="subtitle">'+a.endpoints+"</span>"),"troll-project"==u.getCustomColoringId()){var l=Math.round(100*o.getTrolleyFraction(e,i,this._actuals.routes,r)),d=a&&a.express,h=a&&"mgt"!=a.vendor,f=0==e.indexOf("Тб")?"troll":0==e.indexOf("Тм")?"tram":"bus";if(s+="troll"==f?"Это троллейбусный маршрут. Троллейбус экологичен, чист и бесшумен.":"tram"==f?"Это трамвайный маршрут. Трамвай экологичен, чист и при правильной прокладке путей практически бесшумен.":d&&l>=50?"Это автобус-экспресс. <b>"+l+"%</b> его трассы проходят под троллейбусными проводами, но чтобы он мог обгонять поостановочные троллейбусы, нужно повесить вторую пару проводов. Это будет несложно, так как питающие подстанции и кабели уже на месте.":h&&l>=50?"Этот автобусный маршрут обслуживается частным перевозчиком. <b>"+l+"%</b> его трассы проходят под троллейбусными проводами, поэтому его можно было бы перевести на бесшумный и чистый подвижной состав прямо сейчас, но это потребует пересмотра условий контракта.":l>=50?"Этот автобусный маршрут на <b>"+l+"%</b> проходит под троллейбусными проводами. Грязные дизельные автобусы можно заменить на тихие экологичные троллейбусы хоть завтра, технологии это позволяют.":(l>0?"Этот автобусный маршрут проходит под троллейбусными проводами на <b>"+l+"%</b>. ":"Над этим автобусным маршрутом троллейбусных проводов нет. ")+"К сожалению, текущий уровень развития технологий электротранспорта для нашего климата не позволяет легко заменить его на тихий и экологичный троллейбус.<p>В будущем, возможно, появятся пригодные для нашего климата электробусы, которые помогут нам избавиться от выхлопов дизеля.",a&&a.quantity){var g=a.quantity;s+="<p>Здесь работает <b>"+g+"</b> "+{bus:{one:"автобус",some:"автобуса",many:"автобусов"},troll:{one:"троллейбус",some:"троллейбуса",many:"троллейбусов"},tram:{one:"трамвай",some:"трамвая",many:"трамваев"}}[f][g%10==1&&11!=g?"one":g%10>1&&g%10<5&&1!=Math.floor(g/10)?"some":"many"]+". ","bus"==f&&g&&(s+="В год "+(1==g?"он выбасывает":"они выбасывают")+" в воздух примерно <b>"+3*g+" т</b> опасных газов (CO, оксидов серы и азота).")}return s}if(t[e]){var u=this._stateManager,p=u.getTimeSettings(),m=Object.keys(t[e]).filter(function(e){return e&p.dow});if(t[e][m]){s+='<div class="timetable">';for(var v=p.fromHour;v<=p.toHour;v++)s+='<div class="hour">'+v%24+'<div class="minutes">'+(t[e][m][v]?Array.apply(Array,Array(Math.round(t[e][m][v]))).map(function(){return"."}).join(""):"")+"</div></div>";s+="</div>"}else s+="Маршрут сегодня не ходит"}else s+="Нет данных о частоте движения";return a&&(s+="Перевозчик: <b>"+c[n[e].vendor]+"</b>"),s},this)},getWholeTrollNumber:function(){return i.all([this.getRegistry(),this.getSegmentLengths(),this.getWiredSegments(),this._actualsDeferred.promise()]).spread(function(e,t,n,i){return Object.keys(i.colors).reduce(function(t,n){return t+(0==n.indexOf("Тб")&&e[n]?e[n].quantity:0)},0)},this)},getWholeBusNumber:function(){return i.all([this.getRegistry(),this.getSegmentLengths(),this.getWiredSegments(),this._actualsDeferred.promise()]).spread(function(e,t,n,i){return Object.keys(i.colors).reduce(function(t,n){return t+(-1==n.indexOf("Тб")&&-1==n.indexOf("Тм")&&e[n]?e[n].quantity:0)},0)},this)},getEcoBusNumber:function(){return i.all([this.getRegistry(),this.getSegmentLengths(),this.getWiredSegments(),this._actualsDeferred.promise()]).spread(function(e,t,n,i){var r=this;return Object.keys(i.colors).reduce(function(i,s){var a=-1==s.indexOf("Тб")&&-1==s.indexOf("Тм")&&e[s];return i+(a&&o.getTrolleyFraction(s,t,r._actuals.routes,n)>=.5&&"mgt"==a.vendor&&!a.express?a.quantity:0)},0)},this)},getRouteBounds:function(e){return i.when(this._actualsDeferred.promise()).then(function(t){return t.routeBounds[e]},this)},getMatchingRoutes:function(e,t){return i.when(this._actualsDeferred.promise()).then(function(n){var i=n.existingRoutes,r={"1к":["Тб 8"],5:["м3"],16:["м27"],23:["223"],31:["А"],33:["м1","144к"],37:["м9"],44:["м2"],45:["м8"],48:["м9"],62:["Тб м4"],63:["м7"],84:["Тб м4"],95:["Т79"],25:["м5"]};if(!e)return[];var s=new RegExp("^((Тм )|(Тб )|Т|т|м|С)?"+e+"[а-я]?$","i"),o=new RegExp("^"+e+"(.*)$","i");return i.filter(function(e){return t?s.test(e):o.test(e)&&!s.test(e)}).concat(r[e]).filter(Boolean)},this)},_dropActuals:function(){this._actualsDeferred=i.defer(),this._actuals={},this._actualsReady=!1},setActuals:function(e){this._actualsDeferred.resolve(e),this._actuals=e,this._actualsReady=!0,this.trigger("data-updated")}}),l}),define("utils/deep-equal",[],function(){return function e(t,n){if(t===n)return!0;if(t instanceof Date&&n instanceof Date)return t.getTime()===n.getTime();if(!t||!n||"object"!=typeof t&&"object"!=typeof n||"string"==typeof t||"string"==typeof n)return t===n;var i,r,s=Object.keys(t),o=Object.keys(n);if(s.length!=o.length)return!1;for(s.sort(),o.sort(),i=s.length-1;i>=0;i--)if(s[i]!=o[i])return!1;for(i=s.length-1;i>=0;i--)if(r=s[i],!e(t[r],n[r]))return!1;return typeof t==typeof n}}),define("utils/cache",["utils/extend"],function(e){var t=function(e){this._capacity=e,this._storage={},this._order=[]};return e(t.prototype,{_buildKey:function(){return JSON.stringify([].slice.apply(arguments))},set:function(){var e=[].slice.apply(arguments),t=e.pop(),n=this._buildKey.apply(this,e);this._order.length==this._capacity&&(console.log("cache exceeded",this._capacity),delete this._storage[this._order.shift()]),this._order.push(n),this._storage[n]=t},get:function(){return this._storage[this._buildKey.apply(this,arguments)]},has:function(){return this._buildKey.apply(this,arguments)in this._storage},drop:function(){this._storage={},this._order=[]}}),t}),define("utils/file",[],function(){return{getActualsFileNameByState:function(e,t){if(t)var n=Object.keys(Object.keys(t).reduce(function(e,n){return Object.keys(t[n]).forEach(function(t){e[t]=!0}),e},{})).sort(),i=e.timeSettings.date,r=n.filter(function(e){return+new Date(e)<i}),s=+new Date(r[r.length-1]);return[new Date(s||e.timeSettings.date||void 0).toISOString().substring(0,10),e.timeSettings.dow,e.timeSettings.fromHour,e.timeSettings.toHour,e.widthFactor,e.customColoringId].join("-")}}}),define("worker/utils/tile-utils",["utils/geom","utils/wgs-84"],function(e,t){return{TILE_SIZE:256,getSegmentIdsByTile:function(e,t,n,i){var r=this.tileToGeoBounds(e,t,n,i);return global.tree.search(r[0][0],r[0][1],r[1][0],r[1][1])},offsetLine:function(t,n){return e.offsetLine(t,n)},getZoomFactor:function(e){return 1/(e>15?.5:16-e)},tileToGlobalPixelBounds:function(e,t,n){return[256*e,256*t,256*(e+1),256*(t+1)]},geoPointToTilePixels:function(e,n,i,r){var s=t.toGlobalPixels(e.slice().reverse(),r);return[s[0]-256*n,s[1]-256*i]},tilePixelsToGeoPoint:function(e,n,i,r){var s=[e[0]+256*n,e[1]+256*i];return t.fromGlobalPixels(s,r).reverse()},tileToGeoBounds:function(e,n,i,r){r=r||0;var s=this.tileToGlobalPixelBounds(e,n,i);return[t.fromGlobalPixels([s[0]-r,s[3]+r],i).reverse(),t.fromGlobalPixels([s[2]+r,s[1]-r],i).reverse()]},geoBoundsToTiles:function(e,n){
var i=[t.toGlobalPixels([e[0][1],e[0][0]],n),t.toGlobalPixels([e[1][1],e[1][0]],n)];return{minX:Math.floor(i[0][0]/256),maxY:Math.floor(i[0][1]/256),maxX:Math.floor(i[1][0]/256),minY:Math.floor(i[1][1]/256)}}}}),define("map/worker-canvas-layer",["ymaps","utils/extend","utils/cache"],function(e,t,n){var i=256;e.modules.define("worker-canvas-layer",["util.imageLoader","Layer","util.defineClass"],function(r,s,o,a){function u(e){var t=document.createElement("canvas"),n=t.getContext("2d");return t.width=i*e,t.height=i*e,n.lineJoin="round",t}function c(t){var n=e.vow.defer(),i=document.createElement("img");return i.onload=function(){n.resolve(i)},i.onerror=function(){n.reject()},i.setAttribute("src",t),n.promise()}var l=a(function(r,s,o,a){var d=Math.random(),h=this._tileCaches=o;this._layerId=d,this._query=s,this._prerenderedStorageId=a,r.on("updated",function(){this.update()},this);var f=t({tileContainerClass:"default#canvas"},arguments[4]),g=function(t,s){var o=this._query,a=t.number[0],l=t.number[1],d=t.zoom,f=t.scale,g=e.vow.defer(),p=!1;return s.register(function(){p=!0}),h[d]&&h[d].has(a,l,JSON.stringify(o))?g.resolve({target:h[d].get(a,l,JSON.stringify(o))}):(!(this._prerenderedStorageId&&d<=13)||o&&Object.keys(o).length?e.vow.reject():c("tiles/"+this._prerenderedStorageId+"/"+a+"_"+l+"_"+d+"@"+Math.ceil(f)+"x.png")).fail(function(){var t=e.vow.defer(),n=u(f),s=n.getContext("2d");return r.command("renderTile",{x:a,y:l,z:d,devicePixelRatio:f,routes:o&&o.routes,style:o&&o.style}).then(function(e){p||(s.clearRect(0,0,i*f,i*f),e.forEach(function(e){e.prop?s[e.prop]=e.val:s[e.cmd].apply(s,e.args||[])}),t.resolve(n))}),t.promise()}).then(function(e){(h[d]||(h[d]=new n(1e3))).set(a,l,JSON.stringify(o),e),g.resolve({target:e})}),g.promise()}.bind(this);l.superclass.constructor.apply(this,[{tileLoader:g},f].concat([].slice.call(arguments,5)))},o,{update:function(){Object.keys(this._tileCaches).forEach(function(e){this._tileCaches[e].drop()},this),l.superclass.update.apply(this,arguments)},setQuery:function(e){this._query=e,this.update()},setPrerenderedStorageId:function(e){this._prerenderedStorageId=e,this.update()}});r(l)})}),define("map/worker-hotspot-source",["ymaps","utils/extend","jquery"],function(e,t,n){e.modules.define("worker-hotspot-source",["event.Manager","option.Manager","util.defineClass"],function(t,n,i,r){t(r(function(e){this.events=new n,this.options=new i,this._worker=e,this._lastRequestCancelled=!1},{cancelLastRequest:function(){this._lastRequestCancelled=!0},requestObjects:function(t,n,i,r){this._worker.command("renderHotspots",{x:n[0],y:n[1],z:i}).done(function(t){this._lastRequestCancelled||r(t.map(function(t){return new e.hotspot.layer.Object(new e.shape[t.shape.type](new e.geometry.pixel[t.shape.type](t.shape.pixelGeometry),t.shape.params),t.feature,t.options)})),this._lastRequestCancelled=!1})}}))})}),define("view/segment",["jquery","utils/route"],function(e,t){return function(n,i,r){return e("<div/>").addClass("segment").attr("segment-id",n).append(i.filter(t.notPhantom).map(function(n){return e("<div/>").addClass(t.getType(n)).css("backgroundColor",r[n]).html(t.clearType(n))},this))[0]}}),define("map/map",["ymaps","utils/extend","utils/deep-equal","vow","utils/cache","utils/route","utils/file","worker/utils/tile-utils","utils/events-emitter","map/worker-canvas-layer","map/worker-hotspot-source","view/segment"],function(e,t,n,i,r,s,o,a,u,c,c,l){var d=function(n,i,r){this._map=new e.Map("map",t({controls:["zoomControl","geolocationControl"]},{bounds:i.getBounds()}),{minZoom:9,suppressMapOpenBlock:!0,yandexMapDisablePoiInteractivity:!0,avoidFractionalZoom:!0}),this._worker=r,this._dataManager=n,this._stateManager=i,this._tileCaches={},this._currentSegmentRoutes=null,this._selectionLayers=[],n.on("data-updated",function(){this.getMap().balloon.close()},this),this._init()};return t(d.prototype,u),t(d.prototype,{_init:function(){var t=this._map,n=this._worker,i=this._stateManager,r=this._dataManager,s=this;this._stateManager.isMobile()||t.controls.add("rulerControl",{position:{left:10,bottom:10}}),t.panes.append("mgtmap",new(t.panes.get("places").constructor)(t,{zIndex:200})),t.panes.append("selection",new(t.panes.get("places").constructor)(t,{zIndex:201})),t.panes.append("toponyms",new(t.panes.get("places").constructor)(t,{css:{opacity:.5},zIndex:202})),t.panes.append("white",new e.pane.StaticPane(t,{css:{width:"100%",height:"100%",background:"rgba(256, 256, 256, "+(this._stateManager.getWhite()||.7)+")"},zIndex:150})),t.panes.append("background-html",new e.pane.StaticPane(t,{css:{width:"100%",height:"100%"},zIndex:300})),this._map.panes.get("mgtmap").getElement().style.transitionDuration="all 0.3s",e.modules.require(["worker-canvas-layer","worker-hotspot-source"],function(a,u){r.getRoutes().then(function(r){var c=o.getActualsFileNameByState(i.serialize(),r),l=s._rendererLayer=new a(n,null,s._tileCaches,c,{tileTransparent:!0,pane:"mgtmap"}),d=s._hotspotLayer=new e.hotspot.Layer(new u(n));t.layers.add(l),t.layers.add(d),d.events.add("click",s._onHotspotClicked,s),d.events.add("mouseenter",s._onHotspotMouseover,s),d.events.add("mouseleave",s._onHotspotMouseout,s),i.on("state-updated time-settings-updated coloring-id-updated width-factor-updated",function(){l.setPrerenderedStorageId(o.getActualsFileNameByState(i.serialize(),r))})})}),t.layers.add(new e.Layer("http://vec.maps.yandex.net/tiles?l=map&%c&scale={{ scale }}&lang=ru_RU&scale=1&geometry=0",{pane:"toponyms",tileTransparent:!0})),t.events.add("boundschange",this._onBoundsChanged,this),t.balloon.events.add("close",this._onBalloonClosed,this)},_dimRendererLayer:function(){this._rendererLayer.getElement().style.opacity=.2},_restoreRendererLayer:function(){this._rendererLayer.getElement().style.opacity=1},_getSelectionLayerDesc:function(e){var t;return this._selectionLayers.some(function(i){if(n(i.query,e))return t=i,!0}),t},_showSelectionLayer:function(t){this._dimRendererLayer(),this._hideLastVisibleLayer();var n=this._getSelectionLayerDesc(t),i=this._selectionLayers;if(n)n.removingTimeout&&(clearTimeout(n.removingTimeout),delete n.removingTimeout),n.layer.getElement().style.opacity=1,i.indexOf(n)!=i.length-1&&(i.splice(i.indexOf(n),1),i.push(n));else{var r=this;e.modules.require(["worker-canvas-layer"],function(e){var n=new e(r._worker,t,r._tileCaches,null,{tileTransparent:!0,pane:"selection"});r._map.layers.add(n),n.getElement().style.opacity=0,n.getElement().style.transition="opacity ease 0.3s",i.push({query:t,layer:n}),setTimeout(function(){n.getElement().style.opacity=1},10)})}},_removeSelectionLayer:function(e){var t=this._map,n=this._selectionLayers,i=this._getSelectionLayerDesc(e);i&&(i.layer.getElement().style.opacity=0,i.removingTimeout=setTimeout(function(){t.layers.remove(i.layer),n.splice(n.indexOf(i),1)},300)),this._showLastVisibleLayer()},_clearSelectionLayers:function(){this._selectionLayers.filter(function(e){return!e.removingTimeout}).forEach(function(e){this._removeSelectionLayer(e.query)},this)},_hideLastVisibleLayer:function(){var e=this._selectionLayers.filter(function(e){return!e.removingTimeout}),t=e[e.length-1];t&&(t.layer.getElement().style.opacity=0)},_showLastVisibleLayer:function(){var e=this._selectionLayers.filter(function(e){return!e.removingTimeout}),t=e[e.length-1];t?t.layer.getElement().style.opacity=1:this._restoreRendererLayer()},_getIntersectionRoutes:function(e){return this._dataManager.getActualRoutesForSegment(e).then(function(e){if(this._currentSegmentRoutes&&e){var t=this._currentSegmentRoutes;return e.map(function(e){var n=s.strip(e);return s.notPhantom(e)&&-1!==t.indexOf(n)&&n}).filter(Boolean)}},this)},_onHotspotMouseover:function(e){if(this._currentSegmentRoutes&&!this._selectedRoute){var t=e.get("activeObject").getProperties().segmentId;this._getIntersectionRoutes(t).done(function(e){e&&e.length&&e.length<this._currentSegmentRoutes.length&&(this.trigger("highlight-routes",{routes:e}),this.highlightRoutes(e),this._routesHovered=!0)},this)}},_onHotspotMouseout:function(e){if(!this._selectedRoute&&this._currentSegmentRoutes&&this._routesHovered){var t=e.get("activeObject").getProperties().segmentId;this._getIntersectionRoutes(t).done(function(e){e&&(this.trigger("unhighlight-routes",{routes:e}),this.unhighlightRoutes(e),this._routesHovered=!1)},this)}},_onHotspotClicked:function(e){if(!this._selectedRoute){var t=e.get("coords"),n=this._dataManager,r=e.get("activeObject").getProperties().segmentId;n.getActualRoutesForSegment(r).done(function(e){return e=e.filter(s.notPhantom).map(s.strip),i.all(e.reduce(function(e,t){return e[t]=n.getBusColor(t),e},{})).then(function(n){this._map.balloon.open(t,l(r,e,n).outerHTML),this._onBalloonOpen(r,e)},function(){},this)},this)}},_onBalloonOpen:function(e,t){this._currentSegmentRoutes=t.filter(s.notPhantom).map(s.strip),this._showSelectionLayer({routes:this._currentSegmentRoutes})},_onBalloonClosed:function(e){this._clearSelectionLayers(),this._currentSegmentRoutes=null},closeBalloon:function(){this._map.balloon.close()},highlightRoutes:function(e){this._showSelectionLayer({routes:e})},unhighlightRoutes:function(e){this._removeSelectionLayer({routes:e})},showSelectedRoute:function(e){this._dataManager.getRouteBounds(e).then(function(t){this._selectedRoute=e,this._map.setBounds(t).then(function(){this._showSelectionLayer({routes:[e],style:{width:10,outlineWidth:3}})},this)},this)},hideSelectedRoute:function(){this._removeSelectionLayer({routes:[this._selectedRoute],style:{width:10,outlineWidth:3}}),this._selectedRoute=null},_onBoundsChanged:function(e){var t=this._map.getBounds();t[0][0]&&this.trigger("bounds-changed",{bounds:t})},getMap:function(){return this._map},getBackgroundPane:function(){return this._map.panes.get("background-html").getElement()},getControlsPane:function(){return this._map.panes.get("controls").getElement()},setBounds:function(e){return this._map.setBounds(e)}}),d}),define("view/route",["jquery","vow","utils/route"],function(e,t,n){return function(i,r){var s=n.getType(i),o=n.clearType(i),a=e("<div/>").addClass("route-card").append(e("<div/>").addClass("close").html("&times;")).append(e("<div/>").addClass(s).addClass("title").html(o));return t.all([r.getRouteSummaryHtml(i),r.getBusColor(i)]).spread(function(t,n){a.find(".tram, .trolley, .bus").css("background-color",n),a.append(e("<div/>").addClass("route-summary").html(t))},function(e){console.warn(e)}),a}}),define("view/progress",["utils/extend","jquery"],function(e,t){var n=function(e){this._domElem=t("<div/>").addClass("progress").append(t("<div/>").addClass("progress-bar")).appendTo(t(e||"body"))};return e(n.prototype,{show:function(){return this._domElem.addClass("progress_visible"),this},hide:function(){return this._domElem.removeClass("progress_visible"),this},setVal:function(e){return this._domElem.find(".progress-bar").css({width:100*e+"%"}),this}}),n}),define("view/search",["utils/extend","utils/events-emitter","utils/route","vow","jquery"],function(e,t,n,i,r){var s=function(e,t){this._domElem=r("<div/>").addClass("search").append(r("<input/>").addClass("search-input").addClass("search-route")).append(r("<div/>").addClass("search-suggest")).appendTo(r(e||"body")),this._input=this._domElem.find(".search-input"),this._suggest=this._domElem.find(".search-suggest"),this._dataManager=t,this._val=this._input.val(),this._input.on("change keydown",this._onInputChanged.bind(this)).on("blur",this._hideSuggest.bind(this)).on("keyup",this._onKeyDown.bind(this)),this._suggest.on("click",".bus, .trolley, .tram",this._onRouteSelected.bind(this)).on("mouseover",".bus, .trolley, .tram",function(e){this._selectSuggestItem(r(e.target))}.bind(this))};return e(s.prototype,t),e(s.prototype,{show:function(){return this._domElem.addClass("search_visible"),this},hide:function(){return this._domElem.removeClass("search_visible"),this},clear:function(){return this._input.val(""),this._mimicInput(null),this._suggest.html(""),this},_showSuggest:function(){this._suggest.addClass("search-suggest_visible")},_hideSuggest:function(){this._suggest.removeClass("search-suggest_visible")},_onInputChanged:function(){var e=this._input,t=this._dataManager,r=e.val();r!=this._val&&(this._val=r,t.getMatchingRoutes(r,!0).then(function(e){return e.length?e:t.getMatchingRoutes(r,!1)}).then(function(e){var n=e.slice(0,9);return i.all([n,i.all(n.reduce(function(e,n){return e[n]=t.getBusColor(n),e},{})),i.all(n.reduce(function(e,n){return e[n]=t.getActualWidthForRoute(n),e},{}))])}).spread(function(t,i,s){t.sort(function(e,t){var i=n.clearType(e),o=n.clearType(t);return i==r&&o!=r?-1:o==r&&i!=r?1:(s[t]||0)-(s[e]||0)}),this._showSuggest(),e&&e.val()==r?this._setSuggestValues(t,i):this._clearSuggest()},this))},_onKeyDown:function(e){var t=this._suggest.find(".search-suggest-item_selected");if(t.length&&13==e.keyCode)this.trigger("route-selected",this._routeElemToRouteId(t)),e.preventDefault();else if(40==e.keyCode||38==e.keyCode){var n;if(40==e.keyCode)n=t.next(".search-suggest-item"),n.length||(n=r(this._suggest.find(".search-suggest-item")[0]));else{var n=t.prev(".search-suggest-item");if(!n.length){var i=this._suggest.find(".search-suggest-item");n=r(i[i.length-1])}}this._selectSuggestItem(n),e.preventDefault()}else this._onInputChanged()},_selectSuggestItem:function(e){this._suggest.find(".search-suggest-item_selected").removeClass("search-suggest-item_selected"),e.addClass("search-suggest-item_selected"),this._mimicInput(e),this.trigger("route-highlighted",this._routeElemToRouteId(e))},_setSuggestValues:function(e,t){this._suggest.html("").append(e.reduce(function(e,i){var s=n.getType(i),o=n.clearType(i);return e.add(r("<div/>").addClass(s).addClass("search-suggest-item").css("backgroundColor",t[i]).html(o))},r()));var i=r(this._suggest.find(".search-suggest-item")[0]);i.addClass("search-suggest-item_selected"),this._mimicInput(i)},_mimicInput:function(e){e&&e.length?this._input.toggleClass("bus",e.hasClass("bus")).toggleClass("trolley",e.hasClass("trolley")).toggleClass("tram",e.hasClass("tram")).removeClass("search-route").css("backgroundColor",e.css("backgroundColor")):this._input.removeClass("bus trolley tram").addClass("search-route").css("backgroundColor","")},_clearSuggest:function(){this._suggest.html("").append(r("<div/>").addClass("suggest-empty").html("")),this._mimicInput(null)},_onRouteSelected:function(e){this._hideSuggest(),this.trigger("route-selected",this._routeElemToRouteId(e.target))},_routeElemToRouteId:function(e){var e=r(e);return routeNumber=e.text(),routeType=e.hasClass("trolley")?"trolley":e.hasClass("tram")?"tram":"bus",{trolley:"Тб ",bus:"",tram:"Тм "}[routeType]+routeNumber}}),s}),define("view/settings",["utils/extend","utils/events-emitter","jquery"],function(e,t,n){var i={default:"обычные цвета",vendor:"по перевозчику",type:"по типу",black:"все чёрные"},r=function(e,t){this._domElem=n("<div/>").addClass("settings").append(this._button=n("<div/>").addClass("settings__button").click(this.open.bind(this))).append(this._popup=n("<form/>").submit(this._onSubmit.bind(this)).addClass("settings__popup").append(n("<div/>").addClass("settings__close").click(this.close.bind(this))).append(n("<h2/>").addClass("settings__title").text("Настройки")).append(n("<div/>").text("Маршруты по состоянию на").append(this._dateInput=n("<input/>").attr("type","date").addClass("settings__input settings__date").val(new Date(t.timeSettings.date).toISOString().substr(0,10)))).append(n("<div/>").text("Толщина линий — частота рейсов за время").append(n("<div/>").addClass("settings__times").append(n("<div/>").addClass("settings__time-scale").append(Array.apply(Array,Array(25)).map(function(e,t){return n("<div/>").addClass("settings__time-scale-hour").text((t+3)%24)}))).append(n("<div/>").addClass("settings__ranges").append(this._fromTimeInput=n("<input/>").attr({type:"range",min:3,max:27,step:1}).addClass("settings__range settings__from-time").val(t.timeSettings.fromHour)).append(this._toTimeInput=n("<input/>").attr({type:"range",min:3,max:27,step:1}).addClass("settings__range settings__to-time").val(t.timeSettings.toHour))))).append(n("<div/>").text("Раскраска").append(this._coloringInput=n("<select/>").addClass("settings__input settings__select settings__coloring").append(Object.keys(i).map(function(e){return n("<option/>").val(e).text(i[e]).attr("selected",t.customColoringId==e)})))).append(n("<div/>").text("Сделать все линии").append(this._widthFactorInput=n("<select/>").addClass("settings__input settings__select settings__width-factor").append(n("<option/>").val(3).text("в три раза толще").attr("selected",3==t.widthFactor)).append(n("<option/>").val(1).text("обычной толщины").attr("selected",1==t.widthFactor)).append(n("<option/>").val(.33).text("в три раза тоньше").attr("selected",.33==t.widthFactor)).append(n("<option/>").val(0).text("одинаковой толщины").attr("selected",t.isEqualWidthsMode)))).append(n("<input/>").addClass("settings__submit").attr("type","submit").val("Применить"))).appendTo(n(e||"body"))};return e(r.prototype,t),e(r.prototype,{open:function(){return this._popup.addClass("settings__popup_visible"),this},close:function(){return this._popup.removeClass("settings__popup_visible"),this},_onSubmit:function(e){e.preventDefault();var t=this._dateInput.val()&&new Date(this._dateInput.val()),n=t&&1<<(t.getDay()?t.getDay():7)-1;return res={},res.timeSettings={fromHour:this._fromTimeInput.val(),toHour:this._toTimeInput.val()},t&&(res.timeSettings.date=+t,res.timeSettings.dow=n),res.customColoringId=this._coloringInput.val(),res.isEqualWidthsMode=0==this._widthFactorInput.val(),res.widthFactor=+this._widthFactorInput.val()||3,this.trigger("change",res),this.close(),!1}}),r}),define("view/app",["ymaps","jquery","utils/extend","view/route","view/progress","view/search","view/settings","vow","utils/date","utils/events-emitter"],function(e,t,n,i,r,s,o,a,u,c){var l=function(e,t,n){this._map=e,this._stateManager=n,this._dataManager=t,this._init()};return n(l.prototype,c),n(l.prototype,{_init:function(){this._progressView=new r(this._map.getBackgroundPane()),this._searchView=new s(".sidebar",this._dataManager),this._settingsView=new o("body",this._stateManager.serialize()),this._selectedRouteViews={},this._searchView.show(),t(document).on("click",".segment .bus, .segment .trolley, .segment .tram",this._onSelectRoute.bind(this)).on("mouseover",".segment .bus, .segment .trolley, .segment .tram",this._onRouteMouseOver.bind(this)).on("mouseout",".segment .bus, .segment .trolley, .segment .tram",this._onRouteMouseOut.bind(this)).on("click",".route-card .close",this._onDeselectRoute.bind(this)),this._map.on("highlight-routes",this._onRoutesHighlightedOnMap,this).on("unhighlight-routes",this._onRoutesUnhighlightedOnMap,this),this._searchView.on("route-selected",function(e,t){this._searchView.clear().hide(),this.trigger("route-selected",t)},this),this._settingsView.on("change",function(e,t){console.log(t),this.trigger("state-updated",t)},this)},_routeElemToRouteId:function(e){var e=t(e);return routeNumber=e.text(),routeType=e.hasClass("trolley")?"trolley":e.hasClass("tram")?"tram":"bus",{trolley:"Тб ",bus:"",tram:"Тм "}[routeType]+routeNumber},_onSelectRoute:function(e){this._searchView.clear().hide(),this.trigger("route-selected",this._routeElemToRouteId(e.target))},_onRouteMouseOver:function(e){this._map.highlightRoutes([this._routeElemToRouteId(e.target)])},_onRouteMouseOut:function(e){this._map.unhighlightRoutes([this._routeElemToRouteId(e.target)])},_onRoutesHighlightedOnMap:function(e,n){if(n.routes&&n.routes.length){var i=t(".segment .bus, .segment .trolley, .segment .tram");n.routes.forEach(function(e){var n=e.indexOf("Тб")?e.indexOf("Тм")?"bus":"tram":"trolley",r=e.replace(/^(Тб|Тм) /,"");i=i.not(t(".segment").find("."+n).filter(function(e,t){return t.textContent==r}))}),i.addClass("dimmed")}},_onRoutesUnhighlightedOnMap:function(e){t(".segment .dimmed").removeClass("dimmed")},_onDeselectRoute:function(e){this.trigger("route-deselected"),this._searchView.show()},_createSelectedRouteView:function(e){return i(e,this._dataManager).appendTo(".sidebar")},showSelectedRoute:function(e){this._map.closeBalloon(),this._selectedRouteViews[e]=this._createSelectedRouteView(e)},hideSelectedRoute:function(){Object.keys(this._selectedRouteViews).forEach(function(e){this._selectedRouteViews[e].remove(),delete this._selectedRouteViews[e]},this)},showProgress:function(e){this._progressView.setVal(e).show()},hideProgress:function(e){this._progressView.setVal(1).hide()}}),l}),requirejs.config({baseUrl:"js",paths:{jquery:"//yastatic.net/jquery/2.2.0/jquery.min",vow:"//cdn.rawgit.com/dfilatov/vow/0.4.17/vow.min",ymaps:"//api-maps.yandex.ru/2.1.63/?lang=ru_RU&coordorder=lonlat&load=package.full"},shim:{ymaps:{exports:"ymaps"},jquery:{exports:"$"}}}),require(["ymaps","jquery","vow","worker/client","state/manager","data/manager","map/map","view/app","utils/deep-equal"],function(e,t,n,i,r,s,o,a,u){e.ready(function(){var e=new r,t=new s(e),c=new i(t,e),l=new o(t,e,c),d=new a(l,t,e);e.isDebugMode()&&(window.mgtApp={dataManager:t,map:l}),e.on("state-updated",function(){c.command("setup",{state:e.serialize()})}),l.on({"bounds-changed":function(t,n){e.setBounds(n.bounds)},"segment-geometry-changed":function(e,n){t.setSegmentGeometry(n.segmentId,n.geometry)},"split-segment":function(e,i){n.all([t.getSegmentCount(),t.getRoutesForSegment(i.segmentId)]).spread(function(e,n){l.toggleSegmentGeometryEditor(i.segmentId),t.setSegmentGeometry(i.segmentId,i.geometry.slice(0,i.vertexIndex+1)),t.setSegmentGeometry(e,i.geometry.slice(i.vertexIndex)),t.setRoutesForSegment(e,n)})}}),c.on({progress:function(e,t){d.showProgress(t)},ready:function(e){d.hideProgress()},"updated inited":function(){c.command("getActuals").then(function(n){u(e.serialize(),n.state)&&t.setActuals(n.actuals)})}}),d.on({"time-settings-updated":function(t,n){e.setTimeSettings(n)},"coloring-updated":function(t,n){e.setCustomColoringId(n)},"width-factor-updated":function(t,n){e.setWidthFactor(n)},"state-updated":function(t,n){e.setState(n)},"route-selected":function(e,t){l.showSelectedRoute(t),d.showSelectedRoute(t)},"route-deselected":function(e,t){l.hideSelectedRoute(),d.hideSelectedRoute()}})})}),define("app",function(){});